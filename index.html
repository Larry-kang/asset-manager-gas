<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
  <?!= include('css'); ?>
  <title>Asset Manager v4.1.0</title>
</head>

<body>

  <div id="app" class="app-root" v-cloak>

    <!-- MOBILE HEADER -->
    <div class="mobile-header">
      <i class="fa-solid fa-bars" @click="state.menuOpen = true" style="font-size:20px; color:var(--text-primary)"></i>
      <div class="logo-text" style="font-size:16px">ASSET MANAGER</div>
      <div style="width:20px"></div><!-- Spacer -->
    </div>

    <!-- SIDEBAR (Drawer Mode on Mobile) -->
    <div class="sidebar" :class="{ 'open': state.menuOpen }">
      <div class="sidebar-logo">
        <i class="fa-solid fa-gem" style="color:var(--text-gold)"></i>
        <div class="logo-text">ASSET MANAGER</div>
      </div>

      <div class="nav-menu">
        <div class="nav-item" :class="{ active: state.currentView === 'dash' }"
          @click="go('dash'); state.menuOpen=false">
          <i class="fa-solid fa-chart-pie"></i>
          <span>{{ t('Dash') }}</span>
        </div>
        <div class="nav-item" :class="{ active: state.currentView === 'holdings' }"
          @click="go('holdings'); state.menuOpen=false">
          <i class="fa-solid fa-layer-group"></i>
          <span>{{ t('Port') }}</span>
        </div>
        <div class="nav-item" :class="{ active: state.currentView === 'loan' }"
          @click="go('loan'); state.menuOpen=false" data-testid="nav-vault">
          <i class="fa-solid fa-landmark"></i>
          <span>{{ t('Vault') }}</span>
        </div>
        <div class="nav-item" :class="{ active: state.currentView === 'settings' }"
          @click="go('settings'); state.menuOpen=false" data-testid="nav-settings">
          <i class="fa-solid fa-gear"></i>
          <span>{{ t('Sett') }}</span>
        </div>
      </div>

      <div class="user-profile">
        <div
          style="width:32px; height:32px; border-radius:50%; background:#333; display:flex; align-items:center; justify-content:center; font-size:12px">
          MK</div>
        <div style="font-size:13px; color:var(--text-secondary)">Ming-Hao</div>
      </div>
    </div>

    <!-- BOTTOM NAV (Mobile Only) -->
    <div class="bottom-nav">
      <div class="nav-item" :class="{ active: state.currentView === 'dash' }" @click="go('dash')">
        <i class="fa-solid fa-chart-pie"></i>
      </div>
      <div class="nav-item" :class="{ active: state.currentView === 'holdings' }" @click="go('holdings')">
        <i class="fa-solid fa-layer-group"></i>
      </div>
      <div class="nav-item" :class="{ active: state.currentView === 'loan' }" @click="go('loan')">
        <i class="fa-solid fa-landmark"></i>
      </div>
      <div class="nav-item" :class="{ active: state.currentView === 'settings' }" @click="go('settings')">
        <i class="fa-solid fa-gear"></i>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main-content">

      <!-- Mobile Drawer Overlay -->
      <div v-if="state.menuOpen" class="drawer-overlay" @click="state.menuOpen = false"></div>

      <!-- DASHBOARD -->
      <!-- DASHBOARD -->
      <div v-show="state.currentView === 'dash'" class="view active">

        <!-- Centered Balance Header -->
        <div class="dash-header">
          <div class="dash-label">{{ t('NetWarning') }}</div>
          <div class="dash-balance">{{ state.netWorth }}</div>
          <div style="margin-top:-16px; margin-bottom:24px; font-family:var(--font-sans); font-weight:500">
            <span :style="{ color: state.dailyChange >= 0 ? 'var(--color-green)' : 'var(--color-red)' }">
              {{ state.dailyChange >= 0 ? '+' : '' }}{{ fmt(state.dailyChange) }}
            </span>
            <span style="font-size:12px; color:var(--text-secondary)">Today</span>
          </div>

          <div class="dash-actions">
            <button class="btn-gold-pill" @click="openTxModal()"><i class="fa-solid fa-plus"
                style="margin-right:8px"></i> <span>{{ t('AddF') }}</span></button>
            <button class="btn-outline" @click="openTxModal()"><i class="fa-solid fa-arrow-up"></i></button>
            <button class="btn-outline" @click="load(true)"><i class="fa-solid fa-rotate"
                :class="{'fa-spin': state.isLoading}"></i></button>
          </div>
        </div>

        <div class="grid-stack">

          <!-- Assets Section -->
          <div>
            <div class="section-title" data-i18n="Assets">Assets</div>
            <div class="card">
              <!-- Chart + List Layout -->
              <div style="display:flex; gap:32px; align-items:center; flex-wrap:wrap">
                <div style="width:140px; height:140px; position:relative; flex-shrink:0">
                  <canvas id="assetChart"></canvas>
                </div>

                <div id="assetList" style="flex:1; min-width:280px">
                  <div v-for="h in displayedHoldings" :key="h.ticker" class="asset-row">
                    <div style="display:flex; align-items:center">
                      <div class="asset-icon"><i class="fa-solid fa-coins" style="color:var(--text-gold)"></i></div>
                      <div>
                        <div style="font-weight:600; font-size:16px">{{ h.ticker }}</div>
                        <div style="font-size:12px; color:var(--text-secondary)">{{ fmt(h.qty) }} units</div>
                      </div>
                    </div>
                    <div style="text-align:right">
                      <div style="font-weight:600; font-size:16px">${{ fmt(h.valTWD) }}</div>
                      <div style="font-size:12px"
                        :style="{ color: h.pnl >= 0 ? 'var(--color-green)' : 'var(--color-red)' }">
                        {{ h.pnl >= 0 ? '+' : '' }}{{ fmt(h.pnl) }}
                      </div>
                    </div>
                  </div>
                  <div
                    style="text-align:center; padding-top:12px; font-size:13px; color:var(--text-gold); cursor:pointer"
                    @click="go('holdings')">
                    {{ t('ViewAll') }}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Transactions Section -->
          <div>
            <div class="section-title">{{ t('Tx') }}</div>
            <div class="card" id="recentTxList">
              <div v-if="!state.recentTx || state.recentTx.length === 0"
                style="padding:16px; color:var(--text-secondary)">No transactions</div>
              <div v-for="(t, i) in (state.recentTx || []).slice(0, 5)" :key="i" class="tx-row">
                <div style="display:flex; align-items:center; gap:16px">
                  <div
                    style="width:40px; height:40px; border-radius:50%; background:#1A1A1A; display:flex; align-items:center; justify-content:center"
                    :style="{ color: (t.type === '買入' || t.type === '配息') ? 'var(--color-green)' : 'var(--text-primary)' }">
                    <i class="fa-solid"
                      :class="(t.type === '買入' || t.type === '配息') ? 'fa-arrow-down' : 'fa-arrow-up'"></i>
                  </div>
                  <div>
                    <div style="font-weight:600">{{ t.ticker }}</div>
                    <div class="tx-date">{{ new Date(t.date).toLocaleDateString() }}</div>
                  </div>
                </div>
                <div style="text-align:right">
                  <div style="font-weight:600">{{ (t.type === '買入' || t.type === '配息') ? '+' : '-' }} {{ fmt(t.qty *
                    t.price) }}</div>
                  <div style="font-size:12px; color:var(--text-secondary)">{{ t.type }}</div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- PORTFOLIO / HOLDINGS -->
      <div v-show="state.currentView === 'holdings'" class="view">
        <div class="top-header">
          <div class="section-title">{{ t('Port') }}</div>
          <button class="btn-gold-pill" @click="openTxModal()">{{ t('BtnTrade') }}</button>
        </div>
        <div id="holdingsList" class="grid-stack">
          <div v-for="(assets, cat) in groupedHoldings" :key="cat">
            <div v-if="assets.length > 0">
              <div class="section-title" style="font-size:16px; margin-bottom:12px">{{ cat }}</div>
              <div class="card">
                <div v-for="h in assets" :key="h.ticker" class="asset-row" @click="quickTrade(h.ticker, h.cat)">
                  <div style="display:flex; align-items:center">
                    <div>
                      <div style="font-weight:600; font-size:15px; display:flex; align-items:center; gap:8px">
                        {{ h.ticker }}
                        <span v-if="h.isUsd"
                          style="font-size:10px; background:#333; padding:2px 4px; border-radius:4px">USD</span>
                      </div>
                      <div style="font-size:12px; color:var(--text-secondary)">{{ h.qty }} @ {{ fmt(h.qty > 0 ?
                        (h.marketValue / h.qty) : 0) }}</div>
                    </div>
                  </div>
                  <div style="text-align:right">
                    <div style="font-weight:600; font-size:15px">{{ fmt(h.valTWD) }}</div>
                    <div style="font-size:12px"
                      :style="{ color: h.pnl >= 0 ? 'var(--color-green)' : 'var(--color-red)' }">
                      {{ h.cat === '現金' ? '' : (h.pnl >= 0 ? '+' : '') + fmt(h.pnl) + ' (' + h.roi.toFixed(2) + '%)' }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- VAULT / LOANS -->
      <!-- VAULT / LOANS -->
      <div v-show="state.currentView === 'loan'" class="view">
        <div class="top-header">
          <div class="section-title">{{ t('Vault') }}</div>
          <button class="btn-gold-pill" @click="state.isEditMode = false; state.newLoanModal.show = true"
            data-testid="btn-new-loan">{{ t('BtnNewLoan') }}</button>
        </div>

        <!-- VAULT (Integrated Risk & Loans) -->
        <div id="riskList" class="grid-stack" style="margin-bottom:24px">
          <div v-for="r in state.risks" :key="r.source" class="card">
            <!-- HEADER (Click to Expand) -->
            <div @click="toggleRisk(r.source)" style="cursor:pointer">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
                <div class="card-label" style="margin:0; font-size:16px; font-weight:600">{{ r.source }}</div>
                <div style="display:flex; align-items:center; gap:8px">
                  <div class="bg-success"
                    :style="{ background: r.colValTWD > 0 ? (r.status === 'Safe' ? 'var(--color-green)' : (r.status === 'Warning' ? 'var(--color-yellow)' : 'var(--color-red)')) : '#666', color:'#111', opacity:0.8, fontSize:'12px', padding:'2px 8px' }">
                    {{ r.colValTWD > 0 ? r.status : 'Credit' }}
                  </div>
                  <!-- REMOVED HEADER MENU -->
                  <i class="fa-solid fa-chevron-down"
                    :style="{transform: state.expanded.includes(r.source) ? 'rotate(180deg)' : ''}"
                    style="transition:0.3s; font-size:12px; color:var(--text-secondary)"></i>
                </div>
              </div>

              <div style="display:flex; justify-content:space-between; align-items:center">
                <div class="card-value" style="font-size:24px">
                  {{ r.colValTWD > 0 ? r.ratio + (r.ratio === '-' ? '' : '%') : fmt(r.debtTWD) }}
                </div>
                <div style="font-size:13px; color:var(--text-secondary); text-align:right">
                  <div>{{ r.colValTWD > 0 ? 'Health: ' + (r.label.split(': ')[1] || '-') : 'Total Debt' }}</div>
                </div>
              </div>

              <div v-if="r.colValTWD > 0"
                style="height:4px; width:100%; background:#333; margin-top:12px; border-radius:2px; overflow:hidden">
                <div
                  :style="{ height:'100%', width: Math.min(r.ratio === '-' ? 0 : parseFloat(r.ratio), 100) + '%', background: r.status === 'Safe' ? 'var(--color-green)' : (r.status === 'Warning' ? 'var(--color-yellow)' : 'var(--color-red)') }">
                </div>
              </div>

              <div
                style="margin-top:12px; font-size:13px; color:var(--text-secondary); display:flex; justify-content:space-between">
                <span>Col: {{ fmt(r.colValTWD) }}</span>
                <span>Debt: {{ fmt(r.debtTWD) }}</span>
              </div>
            </div>

            <!-- EXPANDED DETAILS (Loans) -->
            <div v-if="state.expanded.includes(r.source)"
              style="margin-top:16px; border-top:1px solid #333; padding-top:16px; animation: fadeIn 0.3s">
              <div v-if="!loanGroups[r.source]" style="color:var(--text-secondary); text-align:center; font-size:13px">
                No loans</div>

              <div v-for="l in loanGroups[r.source]" :key="l.row" class="asset-row" @click="clickLoan(l)"
                style="padding:8px 0; border-bottom:1px solid #222; display:flex; justify-content:space-between; align-items:center">
                <div style="flex:1">
                  <div style="font-weight:600; font-size:15px; display:flex; align-items:center; gap:8px">
                    {{ l.col }}
                    <span style="font-size:12px; color:var(--text-secondary)">{{ fmt(l.principal) }} {{ l.currency
                      }}</span>
                  </div>
                  <div style="font-size:12px; color:var(--text-secondary)">Rate: {{ l.rate }}%</div>
                </div>
                <div style="display:flex; align-items:center; gap:12px">
                  <div style="text-align:right">
                    <div style="font-weight:600">{{ fmt(l.debt * (l.currency === 'USD' ? 32.5 : 1)) }} TWD</div>
                    <div style="font-size:11px; color:#D4B483">{{ t(l.type.replace(/\s/g, '')) }}</div>
                  </div>

                  <!-- DIRECT EDIT BUTTON -->
                  <div @click.stop="openEditLoan(l)"
                    style="width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:50%; background:var(--bg-card-hover); transition:0.2s; cursor:pointer"
                    class="btn-icon-hover">
                    <i class="fa-solid fa-pen" style="color:var(--text-gold); font-size:14px"></i>
                  </div>

                </div>
              </div>
            </div>
          </div>

          <!-- FALLBACK: If a source has loans but NO risk entry (e.g. manual entry without API data), show separate card -->
          <!-- Currently skipping for simplicity as risk usually covers all sources used -->
          <div v-for="(loans, src) in loanGroups" :key="src + '_orphan'">
            <div v-if="!state.risks.find(r => r.source === src)" class="card">
              <div class="section-title" style="margin-bottom:12px">{{ src }} (Unknown Risk)</div>
              <div v-for="l in loans" :key="l.row" class="asset-row" @click="clickLoan(l)">
                <!-- Same Loan Row UI -->
                <div>
                  <div style="font-weight:600">{{ l.col }}</div>
                  <div style="font-size:12px; color:var(--text-secondary)">Rate: {{ l.rate }}%</div>
                </div>
                <div style="text-align:right">{{ fmt(l.principal) }} {{ l.currency }}</div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- SETTINGS -->
      <!-- SETTINGS -->
      <!-- SETTINGS -->
      <div v-show="state.currentView === 'settings'" class="view">
        <div class="top-header">
          <div class="section-title" data-i18n="Sett" style="margin:0">Settings</div>
        </div>
        <div class="grid-stack">
          <div class="card">
            <div class="asset-row">
              <div data-i18n="SysStat">System Status</div>
              <div class="bg-success" data-i18n="Oper">Operational</div>
            </div>
            <div class="asset-row" onclick="google.script.run.runSystemCheck()">
              <div data-i18n="RunDig">Run Diagnostics</div>
              <div style="color:var(--text-secondary)"><i class="fa-solid fa-chevron-right"></i></div>
            </div>

            <!-- New Toggles -->
            <div class="asset-row" @click="toggleTheme()">
              <div>{{ t('Theme') }}</div>
              <div style="color:var(--text-gold)"><i class="fa-solid"
                  :class="state.theme === 'light' ? 'fa-sun' : 'fa-moon'"></i></div>
            </div>
            <div class="asset-row" @click="setLang(state.lang==='zh'?'en':'zh')" data-testid="btn-lang">
              <div>{{ t('Lang') }}</div>
              <div style="color:var(--text-gold)">EN / 中</div>
            </div>

            <div class="asset-row">
              <div>Version</div>
              <div style="color:var(--text-secondary)">v4.1.0</div>
            </div>
          </div>
        </div>

        <!-- DEBUG LOGS -->
        <div style="margin-top:20px; padding:0 4px">
          <div
            style="font-size:12px; color:var(--text-secondary); margin-bottom:8px; display:flex; justify-content:space-between"
            @click="state.showDebug = !state.showDebug">
            <span>Developer Logs</span>
            <span>{{ state.showDebug ? 'Hide' : 'Show' }}</span>
          </div>
          <div v-if="state.showDebug"
            style="background:#111; padding:12px; border-radius:8px; font-family:monospace; font-size:10px; color:#aaa; max-height:200px; overflow-y:auto">
            <div v-for="(l, i) in state.logs" :key="i">{{ l }}</div>
            <div v-if="state.logs.length===0">No logs available</div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- MODALS -->
  <div v-if="state.txModal.show" class="modal-overlay" style="display:flex" @click.self="state.txModal.show = false">
    <div class="modal-content">
      <h3 class="section-title" style="margin-top:0">{{ t('NewTx') }}</h3>
      <input type="date" v-model="state.txModal.date">
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px">
        <select v-model="state.txModal.type">
          <option>買入</option>
          <option>賣出</option>
          <option>配息</option>
        </select>
        <select v-model="state.txModal.cat">
          <option>股票</option>
          <option>加密貨幣</option>
          <option>現金</option>
        </select>
      </div>
      <input type="text" v-model="state.txModal.ticker" placeholder="Ticker (e.g. BTC)" list="tickerList">
      <datalist id="tickerList">
        <option v-for="t in state.knownTickers" :value="t"></option>
      </datalist>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px">
        <input type="number" v-model="state.txModal.qty" placeholder="Qty">
        <input type="number" v-model="state.txModal.price" placeholder="Price">
      </div>
      <div style="margin-bottom:16px">
        <label>{{ t('Currency') }}</label>
        <select v-model="state.txModal.currency">
          <option>TWD</option>
          <option>USD</option>
        </select>
      </div>
      <button class="btn-gold-pill" style="width:100%" id="btnTx" @click="subTx()">{{ t('ConfirmTx') }}</button>
    </div>
  </div>

  <div v-if="state.newLoanModal.show" class="modal-overlay" style="display:flex"
    @click.self="state.newLoanModal.show = false">
    <div class="modal-content">
      <div style="font-size:18px; font-weight:600; margin-bottom:16px">{{ state.isEditMode ? 'Update Loan' :
        t('NewLoan') }}</div>

      <!-- TYPE SELECTOR (Disabled in Edit Mode) -->
      <div style="display:flex; gap:8px; margin-bottom:16px; overflow-x:auto"
        :style="{pointerEvents: state.isEditMode ? 'none' : 'auto', opacity: state.isEditMode ? 0.6 : 1}">
        <div v-for="tag in ['Credit Card', 'Personal Loan', 'Stock Loan', 'Crypto Loan']" :key="tag"
          @click="state.newLoanModal.type = tag; state.newLoanModal.col = ''; state.newLoanModal.colQty = ''"
          class="tag" :class="{active: state.newLoanModal.type === tag}" style="white-space:nowrap">
          {{ t(tag.replace(/\s/g, '')) }}
        </div>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px">
        <!-- Source (Disabled in Edit Mode) -->
        <input type="text" v-model="state.newLoanModal.source" :placeholder="t('Source') + ' (e.g. Fubon)'"
          list="sourceList" :disabled="state.isEditMode">
        <datalist id="sourceList">
          <option value="Fubon"></option>
          <option value="CTBC"></option>
          <option value="Binance"></option>
          <option value="Aave"></option>
        </datalist>
        <input type="date" v-model="state.newLoanModal.date">
      </div>

      <input type="number" v-model="state.newLoanModal.amount" :placeholder="t('Amt')" style="margin-top:12px">

      <!-- CONDITIONAL: Rate & Period (For Personal Loan or Crypto/Stock) -->
      <div v-if="state.newLoanModal.type !== 'Credit Card'"
        style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px">
        <input type="number" v-model="state.newLoanModal.rate" :placeholder="t('Rate')">
        <select v-model="state.newLoanModal.currency">
          <option value="TWD">TWD</option>
          <option value="USD">USD</option>
        </select>
      </div>

      <!-- CONDITIONAL: Personal Loan Extras -->
      <div v-if="state.newLoanModal.type === 'Personal Loan'"
        style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px">
        <input type="number" v-model="state.newLoanModal.period" :placeholder="t('Period')">
        <input type="number" v-model="state.newLoanModal.fee" :placeholder="t('Fee')">
      </div>

      <!-- CONDITIONAL: Collateral (Stock/Crypto Only) -->
      <div v-if="state.newLoanModal.type === 'Stock Loan' || state.newLoanModal.type === 'Crypto Loan'">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px">
          <input type="text" v-model="state.newLoanModal.col" :placeholder="t('Ticker') + ' (e.g. ETH)'">
          <input type="number" v-model="state.newLoanModal.colQty" :placeholder="t('ColQty')">
        </div>
        <div style="display:flex; gap:4px; margin-bottom:12px">
          <div v-for="m in ['Cross', 'Isolated']" :key="m" @click="state.newLoanModal.marginMode = m" class="tag"
            :class="{active: state.newLoanModal.marginMode === m}" style="padding:4px 12px; font-size:12px">{{ t(m) }}
          </div>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px">
          <input type="number" v-model="state.newLoanModal.warn" :placeholder="t('Warn')">
          <input type="number" v-model="state.newLoanModal.liq" :placeholder="t('Liq')">
        </div>
      </div>

      <!-- ADVICE -->
      <div v-if="maxBorrowAdvice"
        style="margin-top:12px; background:rgba(255,215,0,0.1); padding:8px; border-radius:4px; font-size:13px; color:var(--color-gold); display:flex; align-items:center; gap:8px">
        <i class="fa-regular fa-lightbulb"></i>
        <span>{{ t('MaxSafe') }}: {{ fmt(maxBorrowAdvice) }} {{ state.newLoanModal.currency }}</span>
      </div>
      <div style="display:flex; gap:16px; margin-top:24px">
        <button id="newLoanBtn" class="btn-gold-block" style="flex:1" :disabled="!isLoanValid"
          :style="{opacity: isLoanValid ? 1 : 0.5}" @click="subNewLoan()">{{ state.isEditMode ? 'Update' : t('Create')
          }}</button>
        <button class="btn-outline-block" style="flex:1" @click="state.newLoanModal.show = false">{{ t('Cancel')
          }}</button>
      </div>
    </div>
  </div>

  <!-- LOAN ACTION MODAL -->
  <div v-if="state.loanModal.show" class="modal-overlay" style="display:flex"
    @click.self="state.loanModal.show = false">
    <div class="modal-content">
      <h3 class="section-title" style="margin-top:0">{{ state.loanModal.title }}</h3>

      <label>{{ t('ActionType') }}</label>
      <select v-model="state.loanModal.type">
        <option value="repay">Repay (還款)</option>
        <option value="addCol">Add Collateral (補抵押)</option>
        <option value="increaseLoan">Increase Loan (增貸)</option>
        <option value="payPeriod">Pay Interest (繳息/繳期)</option>
        <option value="sell">Sell to Repay (賣出還款)</option>
      </select>

      <div>
        <label>
          {{ state.loanModal.type === 'repay' ? t('RepayAmt') :
          state.loanModal.type === 'addCol' ? t('ColQty') :
          state.loanModal.type === 'increaseLoan' ? t('LoanAmt') :
          state.loanModal.type === 'payPeriod' ? 'N/A' : t('SellQty') }}
        </label>
        <input type="number" v-model="state.loanModal.val" placeholder="Amount or Qty"
          :disabled="state.loanModal.type === 'payPeriod'">

        <div v-if="state.loanModal.type !== 'repay' && state.loanModal.type !== 'payPeriod'">
          <label>
            {{ state.loanModal.type === 'addCol' ? t('NewRate') :
            state.loanModal.type === 'increaseLoan' ? t('Rate') : t('LimitPrice') }}
          </label>
          <input type="number" v-model="state.loanModal.price" placeholder="Price">
        </div>
      </div>

      <button class="btn-gold-pill" id="btnLoan" style="width:100%; margin-top:20px" @click="subLoan()">{{
        t('SubAction') }}</button>
    </div>
  </div>

  <div v-if="state.msg.show" class="modal-overlay" style="display:flex; z-index:300">
    <div class="modal-content" style="text-align:center">
      <h3 class="section-title">{{ state.msg.title }}</h3>
      <p style="color:var(--text-secondary); margin-bottom:24px">{{ state.msg.body }}</p>
      <button class="btn-outline-block" style="width:100%" @click="state.msg.show = false">{{ t('Close') }}</button>
    </div>
  </div>
  </div>

  <!-- SCRIPTS -->
  <?!= include('icons'); ?>
  <?!= include('constants'); ?>

  <script>
    // Legacy openTx helper overridden by Vue state
    // window.openTxModal handled in js.html
    // window.updateLoanUI is no longer needed as Vue handles v-if
  </script>

  <?!= include('js'); ?>

</body>

</html>