<script>
    const { createApp, reactive, onMounted, computed, nextTick, watch } = Vue;

    createApp({
        setup() {
            // --- STATE ---
            const state = reactive({
                // Core Data
                netWorth: 'Loading...',
                dailyChange: 0,
                holdings: [],
                recentTx: [],
                risks: [],
                contracts: [],
                knownTickers: [],

                // Settings & UI
                lang: localStorage.getItem('app_lang') || 'zh',
                theme: localStorage.getItem('app_theme') || 'dark',
                currentView: 'dash',
                isLoading: false,
                menuOpen: false,

                // Modals
                msg: { show: false, title: '', body: '' },
                txModal: { show: false, date: new Date().toISOString().split('T')[0], type: '買入', cat: '股票', ticker: '', qty: '', price: '', currency: 'TWD' },
                loanModal: { show: false, title: '', row: '', source: '', currency: '', type: 'repay', val: '', price: '' },
                newLoanModal: { show: false, source: '', date: new Date().toISOString().split('T')[0], amount: '', rate: '', col: '', colQty: '', type: '加密貨幣', currency: 'USD' },
                expanded: [] // [Source1, Source2...]
            });

            // ... (Computeds remain same) ...

            // --- TOGGLE ACTIONS ---
            function toggleRisk(source) {
                const idx = state.expanded.indexOf(source);
                if (idx > -1) state.expanded.splice(idx, 1);
                else state.expanded.push(source);
            }

            // ... (Rest of Setup) ...

            return {
                state, t: (key) => I18N[state.lang][key] || key, fmt,
                load, setLang, toggleTheme, go, showMsg,
                subTx, subLoan, subNewLoan, quickTrade, clickLoan, toggleRisk,
                groupedHoldings, displayedHoldings, loanGroups,
                // Make helper directly available to templates
                openTxModal: () => { state.txModal.show = true; }
            };
            const groupedHoldings = computed(() => {
                const cats = { '現金': [], '股票': [], '加密貨幣': [] };
                state.holdings.forEach(h => {
                    if (cats[h.cat]) cats[h.cat].push(h);
                    else { if (!cats['股票']) cats['股票'] = []; cats['股票'].push(h); }
                });
                return cats;
            });

            const displayedHoldings = computed(() => {
                return [...state.holdings].sort((a, b) => b.valTWD - a.valTWD).slice(0, 3);
            });

            const loanGroups = computed(() => {
                const groups = {};
                state.contracts.forEach(l => { if (!groups[l.source]) groups[l.source] = []; groups[l.source].push(l); });
                return groups;
            });

            // --- I18N DICTIONARY ---
            const I18N = {
                'en': {
                    'Dash': 'Dashboard', 'Port': 'Portfolio', 'Vault': 'Vault', 'Sett': 'Settings',
                    'NetWarning': 'Total Vault Balance', 'Assets': 'Assets', 'Tx': 'Transactions',
                    'AddF': 'Add Funds', 'ViewAll': 'View All Assets', 'RunDig': 'Run Diagnostics',
                    'SysStat': 'System Status', 'Oper': 'Operational', 'Theme': 'Light Mode', 'Lang': 'Language',
                    // New Loan
                    'NewLoan': 'New Loan Contract', 'Source': 'Source', 'Amt': 'Loan Amount', 'Rate': 'Rate %',
                    'ColInfo': 'Collateral Info', 'Ticker': 'Ticker', 'ColQty': 'Col Qty',
                    'Create': 'Create', 'Cancel': 'Cancel', 'Submit': 'Submit',
                    'Stock': 'Stock', 'Crypto': 'Crypto', 'Credit': 'Credit Loan',
                    // Tx & Loan Actions
                    'NewTx': 'New Transaction', 'Currency': 'Currency', 'ConfirmTx': 'Confirm Transaction',
                    'ActionType': 'Action Type', 'RepayAmt': 'Repay Amount', 'LoanAmt': 'Loan Amount',
                    'SellQty': 'Sell Qty', 'NewRate': 'New Rate (Optional)', 'LimitPrice': 'Limit Price',
                    'SubAction': 'Submit Action', 'Close': 'Close', 'Manage': 'Manage'
                },
                'zh': {
                    'Dash': '儀表板', 'Port': '投資組合', 'Vault': '借貸金庫', 'Sett': '設定',
                    'NetWarning': '總資產餘額', 'Assets': '資產分佈', 'Tx': '近期交易',
                    'AddF': '新增資金', 'ViewAll': '查看所有資產', 'RunDig': '執行系統診斷',
                    'SysStat': '系統狀態', 'Oper': '運作正常', 'Theme': '亮色模式', 'Lang': '語言切換',
                    // New Loan
                    'NewLoan': '建立新借貸合約', 'Source': '來源', 'Amt': '借款金額', 'Rate': '利率 %',
                    'ColInfo': '抵押品資訊', 'Ticker': '代號 (e.g. ETH)', 'ColQty': '抵押數量',
                    'Create': '建立', 'Cancel': '取消', 'Submit': '送出',
                    'Stock': '股票', 'Crypto': '加密貨幣', 'Credit': '信用貸款',
                    // Tx & Loan Actions
                    'NewTx': '新增交易', 'Currency': '幣別', 'ConfirmTx': '確認交易',
                    'ActionType': '操作項目', 'RepayAmt': '還款金額', 'LoanAmt': '借款金額',
                    'SellQty': '賣出數量', 'NewRate': '新利率 (選填)', 'LimitPrice': '限價',
                    'SubAction': '提交操作', 'Close': '關閉', 'Manage': '管理'
                }
            };

            // --- ACTIONS ---
            function load(refresh = false) {
                if (refresh) state.netWorth = 'Loading...';
                state.isLoading = true;
                google.script.run
                    .withSuccessHandler(handleResponse)
                    .withFailureHandler(err => {
                        showMsg('System Error', err.message);
                        state.isLoading = false;
                    })
                    .getDashboardData(refresh);
            }

            function handleResponse(res) {
                state.isLoading = false;
                let d;
                try { d = (typeof res === 'string') ? JSON.parse(res) : res; }
                catch (e) { showMsg('Parse Error', 'Failed to parse server response'); return; }

                if (d.status === 'success' || d.success === true) {
                    state.netWorth = fmt(d.netWorthTWD);
                    state.dailyChange = d.dailyChange || 0;
                    state.holdings = d.holdings || [];
                    state.recentTx = d.recentTx || [];
                    state.risks = d.risks || [];
                    state.contracts = d.contracts || [];
                    state.knownTickers = d.knownTickers || [];

                    // Chart Update
                    let alloc = {};
                    if (d.holdings) d.holdings.forEach(h => alloc[h.cat] = (alloc[h.cat] || 0) + h.valTWD);
                    nextTick(() => renderChart(alloc));

                } else {
                    showMsg('Error', d.message || 'Unknown error');
                }
            }

            function setLang(l) { state.lang = l; localStorage.setItem('app_lang', l); }
            function toggleTheme() {
                state.theme = state.theme === 'dark' ? 'light' : 'dark';
                localStorage.setItem('app_theme', state.theme);
                document.body.classList.toggle('light-mode', state.theme === 'light');
            }
            function go(page) { state.currentView = page; }
            function showMsg(title, body) { state.msg.title = title; state.msg.body = body; state.msg.show = true; }
            function fmt(n) { return (n || 0).toLocaleString('en-US', { maximumFractionDigits: 0 }); }

            // --- SUBMISSIONS ---
            function subTx() {
                const btn = document.getElementById('btnTx');
                if (btn) { btn.disabled = true; btn.innerText = 'Processing...'; } // Safety check

                google.script.run
                    .withSuccessHandler(res => {
                        if (btn) { btn.innerText = 'Confirm'; btn.disabled = false; } // Reset text
                        state.txModal.show = false;
                        res.success ? (showMsg('Success', res.message), load(true)) : showMsg('Failed', res.message);
                    })
                    .withFailureHandler(err => {
                        if (btn) { btn.innerText = 'Confirm'; btn.disabled = false; }
                        showMsg('System Error', err.message);
                    })
                    .addTx(JSON.parse(JSON.stringify(state.txModal)));
            }

            function subNewLoan() {
                const btn = document.getElementById('newLoanBtn');
                if (btn) { btn.disabled = true; btn.innerText = 'Processing...'; }

                google.script.run
                    .withSuccessHandler(res => {
                        if (btn) { btn.disabled = false; btn.innerText = 'Submit'; }
                        state.newLoanModal.show = false;
                        res.success ? (showMsg('Success', res.message), load(true)) : showMsg('Failed', res.message);
                    })
                    .withFailureHandler(err => {
                        console.error('addLoan Failed:', err);
                        if (btn) { btn.disabled = false; btn.innerText = 'Submit'; }
                        showMsg('Error', 'Create Failed: ' + err.message);
                    })
                    .addLoan(JSON.parse(JSON.stringify(state.newLoanModal)));
            }

            function subLoan() {
                // Determine action type from modal state or inferred
                // For now, reusing existing structure where clickLoan sets up state.loanModal
                const d = {
                    row: state.loanModal.row,
                    source: state.loanModal.source,
                    type: state.loanModal.type,
                    val: state.loanModal.val,
                    price: state.loanModal.price
                };

                const btn = document.getElementById('btnLoan');
                if (btn) { btn.disabled = true; btn.innerText = 'Running...'; }

                google.script.run
                    .withSuccessHandler(res => {
                        if (btn) { btn.innerText = 'Submit Action'; btn.disabled = false; }
                        state.loanModal.show = false;
                        res.success ? (showMsg('Success', res.message), load(true)) : showMsg('Failed', res.message);
                    })
                    .withFailureHandler(err => {
                        if (btn) { btn.innerText = 'Submit Action'; btn.disabled = false; }
                        showMsg('System Error', err.message);
                    })
                    .processContractAction(d);
            }

            function quickTrade(ticker, cat) {
                state.txModal.show = true;
                state.txModal.ticker = ticker;
                state.txModal.cat = cat;
                state.txModal.type = '買入';
                state.txModal.date = new Date().toISOString().split('T')[0];
                // Focus
                setTimeout(() => {
                    const el = document.querySelector('input[placeholder="Qty"]'); // Vue structure doesn't use IDs inside v-if well sometimes, but we can access directly
                    // Or keep IDs in templates if unique.
                }, 100);
            }

            function clickLoan(jsonStrOrObj) {
                let l = (typeof jsonStrOrObj === 'string') ? JSON.parse(jsonStrOrObj) : jsonStrOrObj;

                state.loanModal.show = true;
                const manageText = I18N[state.lang]['Manage'] || 'Manage';
                state.loanModal.title = `${manageText}: ${l.col || l.collateral} (${l.source})`;
                state.loanModal.row = l.row;
                state.loanModal.source = l.source;
                state.loanModal.currency = l.currency;
                state.loanModal.type = 'repay';
                state.loanModal.val = '';
                state.loanModal.price = '';
            }

            // --- EXPOSE TO WINDOW (Compatibility) ---
            window.load = load;

            // --- MOUNT HANDLER ---
            onMounted(() => {
                if (state.theme === 'light') document.body.classList.add('light-mode');
                load();
            });

            return {
                state, t: (key) => I18N[state.lang][key] || key, fmt,
                load, setLang, toggleTheme, go, showMsg,
                subTx, subLoan, subNewLoan, quickTrade, clickLoan,
                groupedHoldings, displayedHoldings, loanGroups,
                // Make helper directly available to templates
                openTxModal: () => { state.txModal.show = true; }
            };
        }
    }).mount('#app');

    // --- CHART (Still non-Vue for now) ---
    let myChart = null;
    function renderChart(alloc) {
        const ctx = document.getElementById('assetChart');
        if (!ctx) return;
        if (myChart) myChart.destroy();
        const labels = Object.keys(alloc);
        const data = Object.values(alloc);
        const colors = ['#D4B483', '#3F3F46', '#71717A', '#A1A1AA', '#52525B'];
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderWidth: 0, hoverOffset: 4 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '85%' }
        });
    }
</script>