<script>
    let CACHED_PASS = ''; // Deprecated but kept for signature compatibility if needed

    // function doLogin moved to archive

    function load(refresh = false) {
        if (refresh) setVal('netWorth', 'Loading...');

        google.script.run
            .withSuccessHandler(res => {
                let d;
                try { d = (typeof res === 'string') ? JSON.parse(res) : res; }
                catch (e) { showMsg('Parse Error', 'Failed to parse server response'); return; }

                if (d.status === 'success' || d.success === true) {
                    DATA = d;
                    // setVal('netWorth', fmt(d.netWorthTWD));
                    animateValue('netWorth', 0, d.netWorthTWD, 1000);
                    renderDashboard(d);
                } else {
                    showMsg('Error', d.message || 'Unknown error');
                }
            })
            .withFailureHandler(err => {
                showMsg('Server Error', err.message);
            })
            .getDashboardData();
    }

    function renderDashboard(d) {
        window.APP_DATA = d; // Global Store
        const dc = document.getElementById('dailyChange');
        if (dc) {
            const isPos = d.dailyChange >= 0;
            dc.className = `daily-change-pill ${isPos ? 'positive' : 'negative'}`;
            dc.innerHTML = `${isPos ? '+' : ''}${fmt(d.dailyChange)} Today`;
        }

        renderAssets(d);
        renderTx(d);
        renderHoldings(d);
        renderLoan(d);

        const tList = document.getElementById('tickerList');
        if (tList && d.knownTickers) {
            tList.innerHTML = '';
            d.knownTickers.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                tList.appendChild(opt);
            });
        }
    }

    window.onload = function () {
        const dateInput = document.getElementById('tDate');
        if (dateInput) dateInput.valueAsDate = new Date();

        loadSettings();
        load();
    };

    function setVal(id, val) { const el = document.getElementById(id); if (el) el.innerText = val; }
    function fmt(n) {
        if (n === undefined || n === null) return '-';
        const config = {
            style: 'currency',
            currency: CURRENCY,
            minimumFractionDigits: (CURRENCY === 'USD') ? 2 : 0,
            maximumFractionDigits: (CURRENCY === 'USD') ? 2 : 0
        };
        // Normalize for USD display symbols if necessary, but Intl usually handles it
        return new Intl.NumberFormat(curLang === 'zh' ? 'zh-TW' : 'en-US', config).format(n);
    }
    function showMsg(title, body) {
        document.getElementById('msgTitle').innerText = title;
        document.getElementById('msgBody').innerText = body;
        document.getElementById('msgModal').style.display = 'flex';
    }

    function renderAssets(d) {
        const skel = document.getElementById('assetSkeleton');
        if (skel) skel.style.display = 'none';

        if (!d.holdings) return;
        const ctx = document.getElementById('assetChart');
        if (!ctx) return;

        let stock = 0, crypto = 0, cash = 0;
        d.holdings.forEach(h => {
            if (h.cat === '股票') stock += h.valTWD;
            else if (h.cat === '加密貨幣') crypto += h.valTWD;
            else cash += h.valTWD;
        });
        CASH = cash;

        const list = document.getElementById('assetList');
        if (list) {
            list.innerHTML = `
<div class="asset-row">
    <div>Stocks</div>
    <div>${fmt(getVal(stock))}</div>
</div>
<div class="asset-row">
    <div>Crypto</div>
    <div>${fmt(getVal(crypto))}</div>
</div>
<div class="asset-row">
    <div>Cash</div>
    <div>${fmt(getVal(cash))}</div>
</div>
`;
        }

        if (window.myChart) window.myChart.destroy();

        // Obsidian Palette
        const colors = {
            stocks: '#D4AF37', // Gold
            crypto: '#38B6FF',  // Blue
            cash: '#888899'     // Muted
        };

        window.myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Stocks', 'Crypto', 'Cash'],
                datasets: [{
                    data: [stock, crypto, cash],
                    backgroundColor: [colors.stocks, colors.crypto, colors.cash],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                cutout: '75%',
                plugins: { legend: { display: false } },
                animation: { animateScale: true, animateRotate: true }
            }
        });
    }

    function renderTx(d) {
        const list = document.getElementById('recentTxList');
        if (!list) return;
        list.innerHTML = '';
        if (!d.recentTx || d.recentTx.length === 0) {
            list.innerHTML = '<div style="text-align:center;color:var(--obsidian-muted);padding:20px">No recent transactions</div>';
            return;
        }
        d.recentTx.slice(0, 5).forEach(t => {
            const isIn = t.type === '買入' || t.type === '配息';
            const row = document.createElement('div');
            row.className = 'asset-row';
            row.innerHTML = `
<div style="display:flex; align-items:center; gap:12px">
    <div
        style="width:40px; height:40px; border-radius:50%; background:var(--obsidian-charcoal); display:flex; align-items:center; justify-content:center; color:${isIn ? 'var(--obsidian-success)' : 'var(--obsidian-muted)'}">
        <i class="fa-solid ${isIn ? 'fa-arrow-down' : 'fa-arrow-up'}"></i>
    </div>
    <div>
        <div style="font-weight:600; color:var(--obsidian-text-main)">${t.ticker}</div>
        <div class="tx-date" style="color:var(--obsidian-muted)">${new Date(t.date).toLocaleDateString()}</div>
    </div>
</div>
<div style="text-align:right">
    <div style="font-weight:600; color:${isIn ? 'var(--obsidian-success)' : 'var(--obsidian-text-main)'}">${isIn ? '+' : '-'} ${fmt(t.qty * t.price)}</div>
    <div style="font-size:12px; color:var(--obsidian-muted)">${t.type}</div>
</div>
`;
            list.appendChild(row);
        });
    }

    function renderHoldings(d) {
        const list = document.getElementById('holdingsList');
        if (!list) return;
        list.innerHTML = '';

        const cats = { '現金': [], '股票': [], '加密貨幣': [] };
        if (d.holdings) {
            d.holdings.forEach(h => {
                if (cats[h.cat]) cats[h.cat].push(h);
                else { if (!cats['股票']) cats['股票'] = []; cats['股票'].push(h); }
            });
        }

        for (let c in cats) {
            if (cats[c].length === 0) continue;
            const hdr = document.createElement('div');
            hdr.className = 'h-label';
            hdr.style.fontSize = '14px';
            hdr.style.textTransform = 'uppercase';
            hdr.style.letterSpacing = '0.05em';
            hdr.style.marginTop = '24px';
            hdr.style.marginBottom = '12px'; // Added spacing
            hdr.innerText = c;
            list.appendChild(hdr);

            const card = document.createElement('div');
            card.className = 'obsidian-card';
            card.style.padding = "0 16px";

            cats[c].forEach(h => {
                if (h.qty <= 0.0001 && h.cat !== '現金') return; const isCash = h.cat === '現金'; const pnlColor = h.pnl >= 0 ?
                    'var(--obsidian-success)' : 'var(--obsidian-danger)';

                const row = document.createElement('div');
                row.className = 'asset-row';
                row.onclick = () => quickTrade(h.ticker, h.cat);

                const roi = parseFloat(h.roi) || 0;
                const roiText = h.qty > 0 ? (roi >= 0 ? `+${roi}%` : `${roi}%`) : '';

                row.innerHTML = `
    <div style="display:flex; align-items:center">
        <div>
            <div style="font-weight:600; font-size:15px; display:flex; align-items:center; gap:8px">
                ${h.ticker}
                ${h.currency === 'USD' ? `<span class="badge-usd">USD</span>` : ''}
            </div>
            <div style="font-size:12px; color:var(--text-secondary)">${h.qty} @ ${fmt(getVal(h.marketPrice || 0))}</div>
        </div>
    </div>
    <div style="text-align:right">
        <div style="font-weight:600; font-size:15px">${fmt(getVal(h.marketValTWD || h.valTWD))}</div>
        <div style="font-size:12px; color:${pnlColor}">${isCash ? '' : `${h.profitTWD >= 0 ? '+' : ''}${fmt(getVal(h.profitTWD || h.pnl))} (${roiText})`}</div>
    </div>
    `;
                card.appendChild(row);
            });
            list.appendChild(card);
        }
    }

    function renderLoan(d) {
        const lList = document.getElementById('loanList');
        const rList = document.getElementById('riskList');
        if (!lList) return;
        lList.innerHTML = ''; rList.innerHTML = '';

        if (!d.risks || d.risks.length === 0) {
            rList.innerHTML = `
    <div
        style="grid-column: 1 / -1; text-align:center; padding:48px 24px; color:var(--text-secondary); background:var(--bg-card); border-radius:16px; border:1px dashed var(--border-color)">
        <i class="fa-solid fa-vault"
            style="font-size:48px; margin-bottom:16px; color:var(--text-gold); opacity:0.5"></i>
        <div style="font-size:16px; font-weight:600; color:var(--text-primary); margin-bottom:8px">${t('NoLoans')}</div>
        <div style="font-size:13px">${t('VaultEmpty')}</div>
    </div>
    `;
            return;
        }

        if (d.risks) {
            d.risks.forEach(r => {
                const riskColor = r.status === 'Safe' ? 'var(--color-green)' : (r.status === 'Warning' ? '#FBBF24' :
                    'var(--color-red)');
                let ratio = parseFloat(r.rate);
                if (isNaN(ratio)) ratio = 0;

                let barPct = Math.min(Math.max(ratio, 0), 100);

                const card = document.createElement('div');
                card.className = 'obsidian-card';
                card.style.position = 'relative';
                card.onclick = () => openLoanAction(r.source, 'repay');

                card.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
        <div class="card-label" style="font-size:16px; font-weight:600; color:white">
            <i class="fa-solid fa-shield-halved" style="margin-right:8px; color:var(--text-gold)"></i>${r.source}
        </div>
        <div
            style="font-size:12px; color:${riskColor}; border:1px solid ${riskColor}; padding:2px 8px; border-radius:12px">
            ${t(r.status)}
        </div>
    </div>
    <div style="margin-bottom:20px">
        <div style="display:flex; justify-content:space-between; align-items:baseline">
            <div style="color:var(--text-secondary); font-size:12px">${t('Ratio')}</div>
            <div class="card-value" style="font-size:24px; color:${riskColor}">${r.rate}</div>
        </div>
        <div class="health-bar-container">
            <div class="health-bar-fill"
                style="width:${barPct}%; background: linear-gradient(90deg, ${riskColor}, ${riskColor}); box-shadow: 0 0 8px ${riskColor}">
            </div>
        </div>
    </div>
    <div
        style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; padding-top:16px; border-top:1px solid var(--border-color)">
        <div>
            <div style="color:var(--text-secondary); font-size:12px; margin-bottom:4px">${t('Collateral')}</div>
            <div style="font-weight:600; font-size:15px; color:white">${fmt(getVal(r.collateral))}</div>
        </div>
        <div style="text-align:right">
            <div style="color:var(--text-secondary); font-size:12px; margin-bottom:4px">${t('Debt')}</div>
            <div style="font-weight:600; font-size:15px; color:white">${fmt(getVal(r.debt))}</div>
        </div>
    </div>
    <div style="margin-top:20px; display:grid; grid-template-columns:1fr 1fr; gap:12px">
        <button class="btn btn-gold" style="width:100%; height:40px; font-size:14px; padding:0"
            onclick="event.stopPropagation(); openLoanAction('${r.source}', 'addCol')">
            <i class="fa-solid fa-plus" style="margin-right:4px"></i>${t('AddCol')}
        </button>
        <button class="btn-outline"
            style="width:100%; height:40px; border-radius:99px; font-size:14px; color:var(--text-secondary); border-color:var(--border-color)"
            onclick="event.stopPropagation(); openLoanAction('${r.source}', 'repay')">
            ${t('Repay')}
        </button>
    </div>`;
                rList.appendChild(card);
            });
        }
    }

    function quickTrade(ticker, cat) {
        openTxModal();
        document.getElementById('tTicker').value = ticker;
        document.getElementById('tCat').value = cat;
    }

    function openLoanAction(source, type) {
        document.getElementById('modalLoan').style.display = 'flex';
        document.getElementById('lSource').value = source;
        const sel = document.getElementById('lType');
        if (type) { sel.value = type; updateLoanUI(type); }
        document.getElementById('lTitle').innerText = `${source} Action`;
    }

    function subLoan() {
        const type = document.getElementById('lType').value;
        const val = parseFloat(document.getElementById('lVal').value);
        if (isNaN(val) && type !== 'payPeriod') { showMsg(t('Error'), t('InvalidVal')); return; }

        const payload = {
            source: document.getElementById('lSource').value,
            type: type,
            val: val,
            price: parseFloat(document.getElementById('lPrice').value) || 0
        };

        setVal('btnLoan', t('Processing'));
        google.script.run.withSuccessHandler(res => {
            setVal('btnLoan', t('SubmitAction'));
            document.getElementById('modalLoan').style.display = 'none';
            if (res.success || res === 'Success') { showMsg(t('Success'), t('ActionRec')); load(true); }
            else showMsg(t('Error'), res.message || res);
        }).processContractAction(payload);
    }

    function subTx() {
        const payload = {
            date: document.getElementById('tDate').value,
            type: document.getElementById('tType').value,
            cat: document.getElementById('tCat').value,
            ticker: document.getElementById('tTicker').value,
            qty: parseFloat(document.getElementById('tQty').value),
            price: parseFloat(document.getElementById('tPrice').value),
            currency: document.getElementById('tCurrency').value
        };
        const btn = document.getElementById('btnTx');
        btn.disabled = true;
        btn.innerText = t('Syncing');

        google.script.run.withSuccessHandler(res => {
            btn.disabled = false;
            btn.innerText = t('ConfirmTx');
            if (res.success || res === 'Transaction Added') {
                closeTxModal();
                showMsg(t('Success'), t('TxRec'));
                // Optimistic UI could go here, but reload is safer for now
                load(true);
            } else showMsg(t('Error'), res.message || res);
        }).addTransaction(payload);
    }

    function triggerEvolution() {
        const btn = document.getElementById('btnEvolve');
        const span = btn.querySelector('span');
        const originalText = span ? span.innerText : 'Evolve';

        if (span) span.innerText = t('Evolving');
        btn.disabled = true;

        google.script.run
            .withSuccessHandler(insights => {
                btn.disabled = false;
                if (span) span.innerText = originalText;
                const count = insights.length;
                showMsg(t('AuditComp'),
                    `${t('AuditRes')} (${count})`);
                load(true);
            })
            .withFailureHandler(err => {
                btn.disabled = false;
                if (span) span.innerText = originalText;
                showMsg(t('EvoFail'), err.message);
            })
            .runEvolution();
    }

    /* --- WIZARD LOGIC --- */
    let wizProto = 'Sinopac';
    let wizType = 'Stock';

    function openWizard() {
        document.getElementById('modalWizard').style.display = 'flex';
        wizBack();
    }
    function closeWizard() { document.getElementById('modalWizard').style.display = 'none'; }

    function setWizProto(proto, type) {
        wizProto = proto; wizType = type;
        document.getElementById('wizStep1').classList.add('hidden');
        document.getElementById('wizStep2').classList.remove('hidden');
        document.getElementById('wizDot2').classList.add('active');
        document.getElementById('wizProtoLabel').innerText = `${proto} (${type})`;
        document.getElementById('wizInputStock').classList.add('hidden');
        document.getElementById('wizInputCrypto').classList.add('hidden');
        document.getElementById('wizInputCredit').classList.add('hidden');

        if (type === 'Stock') initWizStock();
        else if (type === 'Crypto') initWizCrypto();
        else if (type === 'Credit') document.getElementById('wizInputCredit').classList.remove('hidden');
    }

    function wizBack() {
        document.getElementById('wizStep1').classList.remove('hidden');
        document.getElementById('wizStep2').classList.add('hidden');
        document.getElementById('wizDot1').classList.add('active');
        document.getElementById('wizDot2').classList.remove('active');
    }

    function initWizStock() {
        document.getElementById('wizInputStock').classList.remove('hidden');
        const sel = document.getElementById('wizStockTicker');
        sel.innerHTML = '<option disabled selected>Select Stock</option>';
        if (DATA.holdings) {
            DATA.holdings.forEach(h => {
                const opt = document.createElement('option');
                opt.value = h.ticker;
                opt.innerText = `${h.ticker} (Qty: ${h.qty})`;
                sel.appendChild(opt);
            });
        }
        sel.onchange = () => {
            const t = DATA.holdings.find(h => h.ticker === sel.value);
            document.getElementById('wizStockQty').innerText = t ? `Avail: ${t.qty}` : '0';
        };
    }

    function initWizCrypto() {
        document.getElementById('wizInputCrypto').classList.remove('hidden');
        document.getElementById('wizCryptoRows').innerHTML = '';
        addCryptoRow();
    }

    function addCryptoRow() {
        const div = document.createElement('div');
        div.style.marginBottom = '8px';
        div.style.display = 'grid';
        div.style.gridTemplateColumns = '1fr 1fr 32px';
        div.style.gap = '8px';
        div.innerHTML = `
    <input type="text" placeholder="Asset (BTC)" class="wiz-c-asset">
    <input type="number" placeholder="Amt" class="wiz-c-amt">
    <div style="display:flex;align-items:center;justify-content:center;color:red" onclick="this.parentElement.remove()">
        <i class="fa-solid fa-trash"></i></div>
    `;
        document.getElementById('wizCryptoRows').appendChild(div);
    }

    function subWizard() {
        setVal('wizBtn', 'Processing...');
        let payload = {};

        if (wizProto === 'Sinopac') {
            const tTicker = document.getElementById('wizStockTicker').value;
            const tAmt = document.getElementById('wizStockLoan').value;
            if (!tTicker || !tAmt) { showMsg('Error', 'Missing fields'); return; }
            const realTicker = tTicker.split(' ')[0];
            payload = { proto: 'Sinopac', col: realTicker, qty: 1000, amount: tAmt };
        }
        else if (wizProto === 'LineBank') {
            const tAmt = document.getElementById('wizCreditLoan').value;
            payload = { proto: 'LineBank', amount: tAmt };
        }
        else if (wizProto === 'AAVE') {
            const rows = document.querySelectorAll('#wizCryptoRows > div');
            let assets = [];
            rows.forEach(r => {
                const t = r.querySelector('.wiz-c-asset').value;
                const q = r.querySelector('.wiz-c-amt').value;
                if (t && q) assets.push({ ticker: t, qty: q });
            });
            let debt = document.getElementById('wizCryptoBorrow').value;
            payload = { proto: 'AAVE', assets: assets, amount: debt };
        }

        google.script.run.withSuccessHandler(res => {
            closeWizard();
            showMsg('Success', res);
            load(true);
        }).processWizard(payload);
    }

    /* --- SETTINGS --- */
    let CURRENCY = 'TWD';
    let curLang = 'zh';

    function setCurrency(val) {
        CURRENCY = val;
        document.getElementById('btnTWD').classList.toggle('active', val === 'TWD');
        document.getElementById('btnUSD').classList.toggle('active', val === 'USD');
        autoSaveSettings();
        if (DATA && DATA.status) renderDashboard(DATA);
    }

    function toggleLang() { setLang(curLang === 'zh' ? 'en' : 'zh'); }

    function getVal(valTWD) {
        if (CURRENCY === 'USD' && DATA.fx) return valTWD / DATA.fx;
        return valTWD;
    }

    function autoSaveSettings() {
        localStorage.setItem('am_prefs', JSON.stringify({ currency: CURRENCY, lang: curLang }));
    }

    function loadSettings() {
        try {
            const p = JSON.parse(localStorage.getItem('am_prefs'));
            if (p) {
                if (p.currency) setCurrency(p.currency);
                if (p.lang) setLang(p.lang);
            }
        } catch (e) { }
    }

    const i18nData = {
        'SysStat': { zh: '系統狀態', en: 'System Status' },
        'RunDig': { zh: '執行診斷', en: 'Run Diagnostics' },
        'Lang': { zh: '語言', en: 'Language' },
        'Vault': { zh: '金庫', en: 'Vault' },
        'Dash': { zh: '儀表板', en: 'Dashboard' },
        'Tx': { zh: '交易', en: 'Transactions' },
        'Set': { zh: '設定', en: 'Settings' },
        'Set': { zh: '設定', en: 'Settings' },
        'Port': { zh: '投資組合', en: 'Portfolio' },
        'Assets': { zh: '資產', en: 'Assets' },
        'NetWarning': { zh: '總資產淨值', en: 'Total Net Worth' },
        'Evolve': { zh: '進化分析', en: 'Evolve System' },
        'NewLoan': { zh: '新增貸款', en: 'New Loan' },
        'NoLoans': { zh: '無活躍貸款', en: 'No Active Loans' },
        'VaultEmpty': { zh: '您的金庫是空的。建立新貸款以開始。', en: 'Your vault is empty. Create a new loan to get started.' },
        'Ratio': { zh: '抵押率', en: 'Ratio' },
        'Collateral': { zh: '抵押品', en: 'Collateral' },
        'Debt': { zh: '債務', en: 'Debt' },
        'AddCol': { zh: '增加抵押', en: 'Add Col' },
        'Repay': { zh: '還款', en: 'Repay' },
        'Submit': { zh: '提交', en: 'Submit' },
        'Processing': { zh: '處理中...', en: 'Processing...' },
        'Success': { zh: '成功', en: 'Success' },
        'Error': { zh: '錯誤', en: 'Error' },
        'ActionRec': { zh: '操作已記錄', en: 'Action Recorded' },
        'TxRec': { zh: '交易已記錄', en: 'Transaction Added' },
        'InvalidVal': { zh: '無效數值', en: 'Invalid Value' },
        'Syncing': { zh: '同步中...', en: 'Syncing...' },
        'ConfirmTx': { zh: '確認交易', en: 'Confirm Transaction' },
        'Evolving': { zh: '進化中...', en: 'Evolving...' },
        'AuditComp': { zh: '分析完成', en: 'Audit Complete' },
        'AuditRes': { zh: '偵測到建議。請告知代理進行代碼演進。', en: 'points detected. Please ask your Agent to evolve code.' },
        'EvoFail': { zh: '進化失敗', en: 'Evolution Failed' },
        'SubmitAction': { zh: '提交操作', en: 'Submit Action' },
        'Close': { zh: '關閉', en: 'Close' },
        'Appearance': { zh: '外觀', en: 'Appearance' },
        'Diagnostics': { zh: '診斷', en: 'Diagnostics' },
        'SystemStatus': { zh: '系統狀態', en: 'System Status' },
        'Safe': { zh: '安全', en: 'Safe' },
        'Warning': { zh: '警告', en: 'Warning' },
        'Danger': { zh: '危險', en: 'Danger' }
    };

    function t(key) {
        if (!i18nData[key]) return key;
        return i18nData[key][curLang] || i18nData[key]['en'];
    }

    function checkDbStructure() {
        google.script.run.withSuccessHandler(alert).checkDbStructure();
    }

    function resetDatabase() {
        if (confirm('Are you sure you want to RESET the database? This will archive current sheets and create fresh ones.')) {
            google.script.run.withSuccessHandler(alert).resetDatabase();
        }
    }

    function setLang(lang) {
        curLang = lang;
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (i18nData[key] && i18nData[key][lang]) el.innerText = i18nData[key][lang];
        });
    }
    // --- Rebalancing Logic ---

    function openRebalance() {
        console.log('openRebalance called');
        console.log('APP_DATA:', window.APP_DATA);
        let targets = window.APP_DATA.targets || {};
        let suggestions = window.APP_DATA.rebalancing || [];

        let html = '';
        let cats = ['Stock', 'Crypto', 'Cash', 'Credit']; // English categories to avoid encoding issues

        // Merge existing keys from targets if any
        Object.keys(targets).forEach(k => { if (!cats.includes(k)) cats.push(k); });

        cats.forEach(c => {
            let val = targets[c] || 0;
            html += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <span>${c}</span>
            <input type="number" class="reb-input" data-cat="${c}" value="${val}" style="width:60px;">
        </div>`;
        });

        document.getElementById('rebInputs').innerHTML = html;
        console.log('RebInputs HTML set length:', html.length);
        renderSuggestions(suggestions);

        document.getElementById('modalRebalance').style.display = 'flex';
    }

    function renderSuggestions(list) {
        let div = document.getElementById('rebSuggestions');
        if (!list || list.length === 0) {
            div.innerHTML = '<p class="text-muted">Set targets to see suggestions.</p>';
            return;
        }

        let html = '<table class="data-table" style="font-size:0.9em;"><thead><tr><th>Cat</th><th>Target</th><th>Diff</th><th>Action</th></tr></thead><tbody>';
        list.forEach(item => {
            let color = item.action === 'Buy' ? 'text-success' : 'text-danger';
            html += `<tr>
            <td>${item.category}</td>
            <td>${item.targetVal.toLocaleString()}</td>
            <td class="${color}">${item.diff.toLocaleString()}</td>
            <td><strong>${item.action}</strong></td>
        </tr>`;
        });
        html += '</tbody></table>';
        div.innerHTML = html;
    }

    function saveRebalance() {
        let inputs = document.querySelectorAll('.reb-input');
        let targets = {};
        let total = 0;

        inputs.forEach(inp => {
            let val = parseFloat(inp.value) || 0;
            if (val > 0) targets[inp.dataset.cat] = val;
            total += val;
        });

        if (total !== 100) {
            if (!confirm(`Total allocation is ${total}%, not 100%. Save anyway?`)) return;
        }

        showLoader();
        google.script.run.withSuccessHandler(res => {
            if (typeof res === 'string') res = JSON.parse(res);
            if (res.status === 'success') {
                alert('Targets Saved! Refreshing...');
                load(); // Reload dashboard
                closeModal('modalRebalance');
            } else {
                alert('Error: ' + res.message);
            }
            hideLoader();
        }).saveTargets(targets);
    }
    function showLoader() {
        // Simple loader or reuse msgModal with specific text if no loader UI exists
        // For now, assume a loader overlay exists or create one dynamically?
        // Given existing UI, let's just log or set body/cursor.
        // Actually, let's enable the existing loader if any, or create one.
        // Checking index.html... assuming 'modalOverlay' usage or similar.
        // Let's implement a simple implementation:
        let l = document.getElementById('globalLoader');
        if (!l) {
            l = document.createElement('div');
            l.id = 'globalLoader';
            l.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);color:white;display:flex;justify-content:center;align-items:center;z-index:9999;';
            l.innerHTML = '<div class="spinner-border"></div><span>Loading...</span>';
            document.body.appendChild(l);
        }
        l.style.display = 'flex';
    }
    function hideLoader() {
        const l = document.getElementById('globalLoader');
        if (l) l.style.display = 'none';
    }

    function closeModal(id) {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    }
    /* --- HIGH-TECH SFX & ANIMATION --- */
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playSfx(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        const now = audioCtx.currentTime;

        if (type === 'hover') {
            // High pitch short blip
            osc.frequency.setValueAtTime(800, now);
            osc.frequency.exponentialRampToValueAtTime(1200, now + 0.05);
            gain.gain.setValueAtTime(0.05, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
            osc.start(now);
            osc.stop(now + 0.05);
        } else if (type === 'click') {
            // Mech click
            osc.frequency.setValueAtTime(400, now);
            osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
        } else if (type === 'success') {
            // Eth-style success chime
            osc.frequency.setValueAtTime(440, now); // A4
            osc.frequency.setValueAtTime(554, now + 0.1); // C#5
            osc.frequency.setValueAtTime(659, now + 0.2); // E5
            gain.gain.setValueAtTime(0.05, now);
            gain.gain.linearRampToValueAtTime(0.1, now + 0.1);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.6);
            osc.start(now);
            osc.stop(now + 0.6);
        }
    }

    // Auto-attach SFX to buttons
    document.addEventListener('DOMContentLoaded', () => {
        document.body.addEventListener('mouseover', e => {
            if (e.target.closest('button') || e.target.closest('.nav-item') || e.target.closest('.obsidian-card')) {
                // Throttle slightly to avoid spam
                if (Math.random() > 0.5) playSfx('hover');
            }
        });
        document.body.addEventListener('click', e => {
            if (e.target.closest('button') || e.target.closest('.nav-item')) {
                playSfx('click');
            }
        });
    });

    // Number Ticker Animation
    function animateValue(id, start, end, duration) {
        const obj = document.getElementById(id);
        if (!obj) return;
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const val = progress * (end - start) + start;
            obj.innerHTML = fmt(val);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            } else {
                obj.innerHTML = fmt(end); // Ensure exact final value
            }
        };
        window.requestAnimationFrame(step);
    }
</script>