<script>
    const { createApp, reactive, onMounted, computed, nextTick, watch } = Vue;

    createApp({
        setup() {
            // --- STATE ---
            const state = reactive({
                // Core Data
                netWorth: 'Loading...',
                dailyChange: 0,
                holdings: [],
                recentTx: [],
                risks: [],
                contracts: [],
                knownTickers: [],

                // Settings & UI
                lang: localStorage.getItem('app_lang') || 'zh',
                theme: localStorage.getItem('app_theme') || 'dark',
                currentView: 'dash',
                isLoading: false,

                // Modals
                msg: { show: false, title: '', body: '' },
                txModal: { show: false, date: new Date().toISOString().split('T')[0], type: '買入', cat: '股票', ticker: '', qty: '', price: '', currency: 'TWD' },
                loanModal: { show: false, title: '', row: '', source: '', currency: '', type: 'repay', val: '', price: '' }
            });

            // --- COMPUTED ---
            const groupedHoldings = computed(() => {
                const cats = { '現金': [], '股票': [], '加密貨幣': [] };
                state.holdings.forEach(h => {
                    if (cats[h.cat]) cats[h.cat].push(h);
                    else { if (!cats['股票']) cats['股票'] = []; cats['股票'].push(h); }
                });
                return cats;
            });

            const displayedHoldings = computed(() => {
                return [...state.holdings].sort((a, b) => b.valTWD - a.valTWD).slice(0, 3);
            });

            const loanGroups = computed(() => {
                const groups = {};
                state.contracts.forEach(l => { if (!groups[l.source]) groups[l.source] = []; groups[l.source].push(l); });
                return groups;
            });

            // --- I18N DICTIONARY ---
            const I18N = {
                'en': {
                    'Dash': 'Dashboard', 'Port': 'Portfolio', 'Vault': 'Vault', 'Sett': 'Settings',
                    'NetWarning': 'Total Vault Balance', 'Assets': 'Assets', 'Tx': 'Transactions',
                    'AddF': 'Add Funds', 'ViewAll': 'View All Assets', 'RunDig': 'Run Diagnostics',
                    'SysStat': 'System Status', 'Oper': 'Operational', 'Theme': 'Light Mode', 'Lang': 'Language'
                },
                'zh': {
                    'Dash': '儀表板', 'Port': '投資組合', 'Vault': '借貸金庫', 'Sett': '設定',
                    'NetWarning': '總資產餘額', 'Assets': '資產分佈', 'Tx': '近期交易',
                    'AddF': '新增資金', 'ViewAll': '查看所有資產', 'RunDig': '執行系統診斷',
                    'SysStat': '系統狀態', 'Oper': '運作正常', 'Theme': '亮色模式', 'Lang': '語言切換'
                }
            };

            // --- ACTIONS ---
            function load(refresh = false) {
                if (refresh) state.netWorth = 'Loading...';
                state.isLoading = true;
                google.script.run
                    .withSuccessHandler(handleResponse)
                    .withFailureHandler(err => {
                        showMsg('System Error', err.message);
                        state.isLoading = false;
                    })
                    .getDashboardData(refresh);
            }

            function handleResponse(res) {
                state.isLoading = false;
                let d;
                try { d = (typeof res === 'string') ? JSON.parse(res) : res; }
                catch (e) { showMsg('Parse Error', 'Failed to parse server response'); return; }

                if (d.status === 'success' || d.success === true) {
                    state.netWorth = fmt(d.netWorthTWD);
                    state.dailyChange = d.dailyChange || 0;
                    state.holdings = d.holdings || [];
                    state.recentTx = d.recentTx || [];
                    state.risks = d.risks || [];
                    state.contracts = d.contracts || [];
                    state.knownTickers = d.knownTickers || [];

                    // Chart Update
                    let alloc = {};
                    if (d.holdings) d.holdings.forEach(h => alloc[h.cat] = (alloc[h.cat] || 0) + h.valTWD);
                    nextTick(() => renderChart(alloc));

                } else {
                    showMsg('Error', d.message || 'Unknown error');
                }
            }

            function setLang(l) {
                state.lang = l;
                localStorage.setItem('app_lang', l);
            }

            function toggleTheme() {
                state.theme = state.theme === 'light' ? 'dark' : 'light';
                const body = document.body;
                state.theme === 'light' ? body.classList.add('light-mode') : body.classList.remove('light-mode');
                localStorage.setItem('app_theme', state.theme);
            }

            function go(view) {
                state.currentView = view;
            }

            function showMsg(title, body) {
                state.msg = { show: true, title, body };
            }

            function fmt(n) { return new Intl.NumberFormat('en-US').format(Math.round(n)); }

            // --- SUBMISSIONS ---
            function subTx() {
                const tx = { ...state.txModal };
                if (!tx.date || !tx.ticker || !tx.qty || !tx.price) { showMsg("Error", "Missing required fields"); return; }

                const btn = document.getElementById('btnTx');
                const originalText = btn.innerText; btn.innerText = 'Signing...'; btn.disabled = true;

                google.script.run
                    .withSuccessHandler(res => {
                        btn.innerText = originalText; btn.disabled = false; state.txModal.show = false;
                        res.success ? (showMsg('Success', res.message), load(true)) : showMsg('Failed', res.message);
                    })
                    .withFailureHandler(err => { btn.innerText = originalText; btn.disabled = false; showMsg('System Error', err.message); })
                    .addTx(tx);
            }

            function subLoan() {
                const d = { ...state.loanModal };
                if (d.type !== 'payPeriod' && !d.val) { showMsg('Error', 'Please enter Amount/Qty'); return; }

                const btn = document.getElementById('btnLoan');
                const originalText = btn.innerText; btn.innerText = 'Processing...'; btn.disabled = true;
                google.script.run
                    .withSuccessHandler(res => {
                        btn.innerText = originalText; btn.disabled = false; state.loanModal.show = false;
                        res.success ? (showMsg('Success', res.message), load(true)) : showMsg('Failed', res.message);
                    })
                    .withFailureHandler(err => { btn.innerText = originalText; btn.disabled = false; showMsg('System Error', err.message); })
                    .processContractAction(d);
            }

            function quickTrade(ticker, cat) {
                state.txModal.show = true;
                state.txModal.ticker = ticker;
                state.txModal.cat = cat;
                state.txModal.type = '買入';
                state.txModal.date = new Date().toISOString().split('T')[0];
                // Focus
                setTimeout(() => {
                    const el = document.querySelector('input[placeholder="Qty"]'); // Vue structure doesn't use IDs inside v-if well sometimes, but we can access directly
                    // Or keep IDs in templates if unique.
                }, 100);
            }

            function clickLoan(jsonStrOrObj) {
                let l = (typeof jsonStrOrObj === 'string') ? JSON.parse(jsonStrOrObj) : jsonStrOrObj;

                state.loanModal.show = true;
                state.loanModal.title = `Manage: ${l.collateral} (${l.source})`;
                state.loanModal.row = l.row;
                state.loanModal.source = l.source;
                state.loanModal.currency = l.currency;
                state.loanModal.type = 'repay';
                state.loanModal.val = '';
                state.loanModal.price = '';
            }

            // --- EXPOSE TO WINDOW (Compatibility) ---
            window.load = load;

            // --- MOUNT HANDLER ---
            onMounted(() => {
                if (state.theme === 'light') document.body.classList.add('light-mode');
                load();
            });

            return {
                state, t: (key) => I18N[state.lang][key] || key, fmt,
                load, setLang, toggleTheme, go, showMsg,
                subTx, subLoan, quickTrade, clickLoan,
                groupedHoldings, displayedHoldings, loanGroups,
                // Make helper directly available to templates
                openTxModal: () => { state.txModal.show = true; }
            };
        }
    }).mount('#app');

    // --- CHART (Still non-Vue for now) ---
    let myChart = null;
    function renderChart(alloc) {
        const ctx = document.getElementById('assetChart');
        if (!ctx) return;
        if (myChart) myChart.destroy();
        const labels = Object.keys(alloc);
        const data = Object.values(alloc);
        const colors = ['#D4B483', '#3F3F46', '#71717A', '#A1A1AA', '#52525B'];
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderWidth: 0, hoverOffset: 4 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '85%' }
        });
    }
</script>