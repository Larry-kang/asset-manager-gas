<script>
  const el = (id) => document.getElementById(id);
  const val = (id) => el(id).value;

  // --- State & Config ---
  const Store = { data: null, currency: 'TWD', fx: 32.5, inventory: {}, theme: 'light', sort: 'val' };

  // --- iOS UI Components ---
  const UI = {
    // List Row
    row: (icon, title, subtitle, rightVal, rightSub = '', onClick = null) => `
      <div class="ios-row" ${onClick ? `onclick="${onClick}"` : ''}>
         <div class="flex-cnt">
           ${icon ? `<span style="font-size:24px">${icon}</span>` : ''}
           <div><div class="text-main">${title}</div><div class="text-sub">${subtitle}</div></div>
         </div>
         <div style="text-align:right">
           <div class="text-val">${rightVal}</div><div class="text-sub" style="font-size:12px">${rightSub}</div>
         </div>
      </div>`,

    // Section Header
    header: (text) => `<h3>${text}</h3>`,

    // Badge
    badge: (text, type = 'safe') => `<span class="badge badge-${type}">${text}</span>`
  };

  // --- Navigation Stack ---
  function go(viewId) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));

    el(viewId).classList.add('active');

    // Update Tab Bar
    const tab = document.querySelector(`.tab-item[onclick*="'${viewId}'"]`);
    if (tab) tab.classList.add('active');

    // Update Nav Title
    const fileMap = { 'dash': '概覽', 'holdings': '持倉', 'loan': '借貸', 'settings': '設定' };
    el('navTitle').innerText = fileMap[viewId] || '資產管家';

    // Auto refresh data
    if (viewId === 'dash' || viewId === 'holdings' || viewId === 'loan') load(false);
  }

  // --- Bottom Sheet ---
  function openSheet(id) {
    const overlay = el(id);
    const content = overlay.querySelector('.sheet-content');
    overlay.style.display = 'block';
    setTimeout(() => {
      overlay.style.opacity = '1';
      content.style.transform = 'translateY(0)';
    }, 10);
  }

  function closeSheet(id) {
    const overlay = el(id);
    const content = overlay.querySelector('.sheet-content');
    content.style.transform = 'translateY(100%)';
    overlay.style.opacity = '0';
    setTimeout(() => { overlay.style.display = 'none'; }, 300);
  }

  // Close sheet when clicking overlay
  document.querySelectorAll('.sheet-overlay').forEach(ov => {
    ov.addEventListener('click', (e) => { if (e.target === ov) closeSheet(ov.id); });
  });

  // --- Theme ---
  function initTheme() {
    const saved = localStorage.getItem('theme') || 'light';
    setTheme(saved);
  }
  function toggleTheme() { setTheme(Store.theme === 'light' ? 'dark' : 'light'); }
  function setTheme(t) {
    Store.theme = t;
    document.documentElement.setAttribute('data-theme', t);
    localStorage.setItem('theme', t);
  }

  // --- Render Logic (Adapted for iOS) ---
  function load(force) {
    if (force) el('navTitle').innerText = '更新中...';
    google.script.run.withSuccessHandler(render).getDashboardData(force);
  }

  function render(payload) {
    el('navTitle').innerText = '資產管家';
    if (!payload) return;
    let d = (typeof payload === 'string') ? JSON.parse(payload) : payload;

    if (d.status === 'error') { alert(d.message); return; }

    Store.data = d; Store.inventory = d.inventory; Store.fx = d.fx;

    // 1. Dashboard Charts
    renderCharts(d);
    el('netWorth').innerText = formatMoney(d.netWorthTWD);
    el('totalAssets').innerText = formatMoney(d.totalAssetsTWD);
    el('totalDebt').innerText = formatMoney(d.totalDebtTWD);

    // 2. Holdings List
    renderHoldings(d.holdings);

    // 3. Loans & Risks
    renderLoans(d.contracts);
    renderRisks(d.risks);

    // 4. Misc
    if (d.knownTickers) updateDatalist(d.knownTickers);
  }

  function renderHoldings(list) {
    let html = '';

    // Group by Category
    const cats = { '現金': [], '股票': [], '加密貨幣': [] };
    list.forEach(h => { if (cats[h.cat]) cats[h.cat].push(h); else cats['股票'].push(h); }); // Fallback

    for (let c in cats) {
      if (cats[c].length === 0) continue;
      html += UI.header(c);
      html += '<div class="ios-list">';
      cats[c].forEach(h => {
        if (h.qty <= 0.0001) return;
        let pnlClass = h.pnl >= 0 ? 'text-red' : 'text-green'; // TW style
        let subRight = h.cat === '現金' ? '' : `<span class="${pnlClass}">${h.roi.toFixed(2)}%</span>`;
        let title = h.ticker;
        html += UI.row(null, title, `${h.qty} • ${formatMoney(h.marketPrice)}`, formatMoney(h.valTWD), subRight, `quickTrade('${h.ticker}', '${h.cat}')`);
      });
      html += '</div>';
    }
    el('holdingsList').innerHTML = html;
  }

  function renderLoans(list) {
    if (!list || list.length === 0) { el('loanList').innerHTML = '<p class="text-sub" style="text-align:center;padding:20px">無借貸合約</p>'; return; }

    let html = '';
    // Group by Source
    let groups = {};
    list.forEach(c => { if (!groups[c.source]) groups[c.source] = []; groups[c.source].push(c); });

    for (let src in groups) {
      html += UI.header(src);
      html += '<div class="ios-list">';
      groups[src].forEach(c => {
        let title = (c.type === '信用貸款' || c.type === '卡費') ? c.type : c.col;
        let sub = (c.type === '信用貸款') ? `剩 ${c.totalTerm - c.paidTerm} 期` : `利率 ${c.rate}%`;
        html += UI.row(null, title, sub, formatMoney(c.debt, c.currency), c.note, `clickLoan('${c.row}')`);
      });
      html += '</div>';
    }
    el('loanList').innerHTML = html;
  }

  function renderRisks(list) {
    if (!list) return;
    let html = '<div class="chart-scroll">'; // Reuse scroll container for risk cards
    list.forEach(r => {
      if (r.status === 'Safe') return; // Only show non-safe risks? Or show all. Let's show all.
      let badge = r.status === 'Safe' ? 'safe' : (r.status === 'Warning' ? 'warn' : 'dang');
      html += `<div class="chart-card" style="flex:0 0 160px">
             <div class="text-sub" style="font-size:12px">${r.source}</div>
             <div class="text-val" style="margin:5px 0">${r.type}</div>
             ${UI.badge(r.ratio + '%', badge)}
             <div class="text-sub" style="font-size:11px;margin-top:5px">${r.label}</div>
          </div>`;
    });
    html += '</div>';
    el('riskList').innerHTML = html;
  }

  // --- Chart.js Wrapper ---
  let chartInstance = null;
  function renderCharts(d) {
    const ctx = el('assetChart').getContext('2d');
    if (chartInstance) chartInstance.destroy();

    // Simple Pie
    let cats = { '股票': 0, '加密貨幣': 0, '現金': 0 };
    d.holdings.forEach(h => { if (cats[h.cat] !== undefined) cats[h.cat] += h.valTWD; else cats['股票'] += h.valTWD; });

    chartInstance = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(cats),
        datasets: [{ data: Object.values(cats), backgroundColor: ['#007AFF', '#FFCC00', '#34C759'], borderWidth: 0 }]
      },
      options: { plugins: { legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 8 } } }, cutout: '70%' }
    });
  }

  // --- Formatters ---
  function formatMoney(n, curr = 'TWD') {
    if (!n) n = 0;
    if (Store.currency === 'USD' || curr === 'USD') return '$' + Number(n).toLocaleString();
    return 'NT$' + Math.round(n).toLocaleString();
  }

  // --- Actions ---
  function quickTrade(t, c) {
    openSheet('sheetTx');
    el('tTicker').value = t;
    el('tType').value = '買入';
    el('tCat').value = c;
  }

  function subTx() {
    // Collect Data
    let d = {
      date: el('tDate').value, type: el('tType').value, ticker: el('tTicker').value,
      cat: el('tCat').value, qty: el('tQty').value, price: el('tPrice').value, currency: el('tCurrency').value
    };

    el('btnTx').disabled = true; el('btnTx').innerText = '處理中...';
    google.script.run.withSuccessHandler(r => {
      closeSheet('sheetTx'); load(false); alert(r.message);
      el('btnTx').disabled = false; el('btnTx').innerText = '送出交易';
      // Reset form
      el('tQty').value = ''; el('tPrice').value = '';
    }).addTx(d);
  }

  window.onload = () => {
    initTheme();
    el('tDate').value = new Date().toISOString().split('T')[0];
    load(false);
  };
</script>