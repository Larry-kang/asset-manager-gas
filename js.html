<script>
    const { createApp, reactive, onMounted, computed, nextTick } = Vue;

    createApp({
        setup() {
            // --- STATE (Reactive Data Source) ---
            const state = reactive({
                // Core Data
                netWorth: 'Loading...',
                dailyChange: 0,
                holdings: [],
                recentTx: [],
                risks: [],
                contracts: [],
                knownTickers: [],

                // Settings & UI
                lang: localStorage.getItem('app_lang') || 'zh',
                theme: localStorage.getItem('app_theme') || 'dark',
                currentView: 'dash',
                isLoading: false,

                // Modals
                msg: { show: false, title: '', body: '' },
                txModal: { show: false, date: new Date().toISOString().split('T')[0], type: '買入', cat: '股票', ticker: '', qty: '', price: '', currency: 'TWD' },
                loanModal: { show: false, title: '', row: '', source: '', currency: '', type: 'repay', val: '', price: '' }
            });

            // --- COMPUTED (Reserved for Template Migration) ---
            const displayedHoldings = computed(() => {
                return [...state.holdings].sort((a, b) => b.valTWD - a.valTWD).slice(0, 3);
            });

            // --- I18N DICTIONARY ---
            const I18N = {
                'en': {
                    'Dash': 'Dashboard', 'Port': 'Portfolio', 'Vault': 'Vault', 'Sett': 'Settings',
                    'NetWarning': 'Total Vault Balance', 'Assets': 'Assets', 'Tx': 'Transactions',
                    'AddF': 'Add Funds', 'ViewAll': 'View All Assets', 'RunDig': 'Run Diagnostics',
                    'SysStat': 'System Status', 'Oper': 'Operational', 'Theme': 'Light Mode', 'Lang': 'Language'
                },
                'zh': {
                    'Dash': '儀表板', 'Port': '投資組合', 'Vault': '借貸金庫', 'Sett': '設定',
                    'NetWarning': '總資產餘額', 'Assets': '資產分佈', 'Tx': '近期交易',
                    'AddF': '新增資金', 'ViewAll': '查看所有資產', 'RunDig': '執行系統診斷',
                    'SysStat': '系統狀態', 'Oper': '運作正常', 'Theme': '亮色模式', 'Lang': '語言切換'
                }
            };

            // --- CORE LOGIC ---
            function load(refresh = false) {
                if (refresh) state.netWorth = 'Loading...';

                // [LEGACY] Update DOM ID if exists (until template migration)
                const nwEl = document.getElementById('netWorth');
                if (nwEl) nwEl.innerText = 'Loading...';

                state.isLoading = true;
                google.script.run
                    .withSuccessHandler(res => {
                        handleResponse(res);
                        state.isLoading = false;
                    })
                    .withFailureHandler(err => {
                        showMsg('System Error', err.message);
                        state.isLoading = false;
                    })
                    .getDashboardData(refresh);
            }

            function handleResponse(res) {
                let d;
                try { d = (typeof res === 'string') ? JSON.parse(res) : res; }
                catch (e) { showMsg('Parse Error', 'Failed to parse server response'); return; }

                if (d.status === 'success' || d.success === true) {
                    // Update Reactive State
                    state.netWorth = fmt(d.netWorthTWD);
                    state.dailyChange = d.dailyChange || 0;
                    state.holdings = d.holdings || [];
                    state.recentTx = d.recentTx || [];
                    state.risks = d.risks || [];
                    state.contracts = d.contracts || [];
                    state.knownTickers = d.knownTickers || [];

                    // [LEGACY] Trigger original render functions
                    nextTick(() => {
                        renderDash(d);
                        renderHoldings(d);
                        renderLoan(d);
                        if (d.knownTickers) {
                            const dl = document.getElementById('tickerList');
                            if (dl) dl.innerHTML = d.knownTickers.map(t => `<option value="${t}">`).join('');
                        }
                    });
                } else {
                    showMsg('Error', d.message || 'Unknown error');
                }
            }

            function setLang(l) {
                state.lang = l;
                localStorage.setItem('app_lang', l);
                // [LEGACY] Manual DOM update
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (I18N[l][key]) el.innerText = I18N[l][key];
                });
            }

            function toggleTheme() {
                state.theme = state.theme === 'light' ? 'dark' : 'light';
                const body = document.body;
                state.theme === 'light' ? body.classList.add('light-mode') : body.classList.remove('light-mode');
                localStorage.setItem('app_theme', state.theme);
            }

            function go(view, el) {
                state.currentView = view;

                // [LEGACY] Manual visibility toggle
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active', 'hidden'));
                document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));

                const target = document.getElementById(view);
                if (target) { target.classList.remove('hidden'); target.classList.add('active'); }

                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                if (el) el.classList.add('active');
            }

            function showMsg(title, body) {
                state.msg = { show: true, title, body };
                // [LEGACY]
                document.getElementById('msgTitle').innerText = title;
                document.getElementById('msgBody').innerText = body;
                document.getElementById('msgModal').style.display = 'flex';
            }

            function fmt(n) { return new Intl.NumberFormat('en-US').format(Math.round(n)); }

            // --- EXPOSE TO WINDOW (Compatibility) ---
            window.load = load;
            window.setLang = setLang;
            window.toggleTheme = toggleTheme;
            window.go = go;

            // Submissions
            window.openTxModal = () => { document.getElementById('modalOverlay').style.display = 'flex'; document.getElementById('tDate').valueAsDate = new Date(); };
            window.closeTxModal = () => { document.getElementById('modalOverlay').style.display = 'none'; };

            window.subTx = function () {
                const tx = {
                    date: document.getElementById('tDate').value,
                    type: document.getElementById('tType').value,
                    category: document.getElementById('tCat').value,
                    ticker: document.getElementById('tTicker').value,
                    qty: document.getElementById('tQty').value,
                    price: document.getElementById('tPrice').value,
                    currency: document.getElementById('tCurrency').value
                };
                if (!tx.date || !tx.ticker || !tx.qty || !tx.price) { showMsg("Error", "Missing required fields"); return; }

                const btn = document.getElementById('btnTx');
                const originalText = btn.innerText; btn.innerText = 'Signing...'; btn.disabled = true;

                google.script.run
                    .withSuccessHandler(res => {
                        btn.innerText = originalText; btn.disabled = false; window.closeTxModal();
                        res.success ? (showMsg('Success', res.message), load(true)) : showMsg('Failed', res.message);
                    })
                    .withFailureHandler(err => { btn.innerText = originalText; btn.disabled = false; showMsg('System Error', err.message); })
                    .addTx(tx);
            };

            window.subLoan = function () {
                const d = {
                    row: document.getElementById('lRow').value,
                    source: document.getElementById('lSource').value,
                    type: document.getElementById('lType').value,
                    val: document.getElementById('lVal').value,
                    price: document.getElementById('lPrice').value,
                };
                if (d.type !== 'payPeriod' && !d.val) { showMsg('Error', 'Please enter Amount/Qty'); return; }

                const btn = document.getElementById('btnLoan');
                const originalText = btn.innerText; btn.innerText = 'Processing...'; btn.disabled = true;
                google.script.run
                    .withSuccessHandler(res => {
                        btn.innerText = originalText; btn.disabled = false; document.getElementById('modalLoan').style.display = 'none';
                        res.success ? (showMsg('Success', res.message), load(true)) : showMsg('Failed', res.message);
                    })
                    .withFailureHandler(err => { btn.innerText = originalText; btn.disabled = false; showMsg('System Error', err.message); })
                    .processContractAction(d);
            };

            window.quickTrade = function (ticker, cat) {
                document.getElementById('modalOverlay').style.display = 'flex';
                document.getElementById('tTicker').value = ticker;
                document.getElementById('tCat').value = cat;
                document.getElementById('tType').value = '買入';
                document.getElementById('tDate').valueAsDate = new Date();
                setTimeout(() => document.getElementById('tQty').focus(), 100);
            };

            window.clickLoan = function (jsonStr) {
                const l = JSON.parse(decodeURIComponent(escape(atob(jsonStr))));
                document.getElementById('modalLoan').style.display = 'flex';
                document.getElementById('lTitle').innerText = `Manage: ${l.collateral} (${l.source})`;
                document.getElementById('lRow').value = l.row;
                document.getElementById('lSource').value = l.source;
                document.getElementById('lCurrency').value = l.currency;
                document.getElementById('lType').value = 'repay';
                if (window.updateLoanUI) window.updateLoanUI('repay');
            };

            // --- MOUNT HANDLER ---
            onMounted(() => {
                const savedTheme = localStorage.getItem('app_theme');
                if (savedTheme === 'light') document.body.classList.add('light-mode');

                // Initialize I18N
                setTimeout(() => setLang(state.lang), 100);

                load();
            });

            return { state };
        }
    }).mount('#app');

    // --- LEGACY RENDER FUNCTIONS (OUTSIDE VUE SCOPE FOR NOW) ---
    // These need access to state or args. Since they are called by load() with 'd', they are fine.

    function renderDash(d) {
        const nw = document.getElementById('netWorth');
        if (nw) nw.innerText = new Intl.NumberFormat('en-US').format(Math.round(d.netWorthTWD));  // inline fmt

        const dcEl = document.getElementById('dailyChange');
        if (dcEl) {
            let dc = d.dailyChange || 0;
            let color = dc >= 0 ? 'var(--color-green)' : 'var(--color-red)';
            let sign = dc >= 0 ? '+' : '';
            dcEl.innerHTML = `<span style="color:${color}">${sign}${new Intl.NumberFormat('en-US').format(Math.round(dc))}</span> <span style="font-size:12px; color:var(--text-secondary)">Today</span>`;
        }

        let alloc = {};
        if (d.holdings) {
            d.holdings.forEach(h => {
                alloc[h.cat] = (alloc[h.cat] || 0) + h.valTWD;
            });
        }
        renderChart(alloc);
        renderAssetList(d.holdings);
        renderRecentTx(d.recentTx);
    }

    let myChart = null;
    function renderChart(alloc) {
        const ctx = document.getElementById('assetChart');
        if (!ctx) return;
        if (myChart) myChart.destroy();
        const labels = Object.keys(alloc);
        const data = Object.values(alloc);
        const colors = ['#D4B483', '#3F3F46', '#71717A', '#A1A1AA', '#52525B'];
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderWidth: 0, hoverOffset: 4 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '85%' }
        });
    }

    function renderAssetList(holdings) {
        const el = document.getElementById('assetList');
        if (!el) return;
        el.innerHTML = '';
        if (!holdings) return;

        let sorted = [...holdings].sort((a, b) => b.valTWD - a.valTWD).slice(0, 3);
        const fmt = (n) => new Intl.NumberFormat('en-US').format(Math.round(n));

        sorted.forEach(h => {
            const row = document.createElement('div');
            row.className = 'asset-row';
            row.innerHTML = `
           <div style="display:flex; align-items:center">
             <div class="asset-icon"><i class="fa-solid fa-coins" style="color:var(--text-gold)"></i></div>
             <div>
               <div style="font-weight:600; font-size:16px">${h.ticker}</div>
               <div style="font-size:12px; color:var(--text-secondary)">${fmt(h.qty)} units</div>
             </div>
           </div>
           <div style="text-align:right">
             <div style="font-weight:600; font-size:16px">$${fmt(h.valTWD)}</div>
             <div style="font-size:12px; color:${h.pnl >= 0 ? 'var(--color-green)' : 'var(--color-red)'}">${h.pnl >= 0 ? '+' : ''}${fmt(h.pnl)}</div>
           </div>
        `;
            el.appendChild(row);
        });

        const more = document.createElement('div');
        more.style = "text-align:center; padding-top:12px; font-size:13px; color:var(--text-gold); cursor:pointer";
        more.innerText = "View All Assets";
        more.onclick = () => window.go('holdings');
        el.appendChild(more);
    }

    function renderRecentTx(txs) {
        const el = document.getElementById('recentTxList');
        if (!el) return;
        el.innerHTML = '';
        if (!txs || txs.length === 0) { el.innerHTML = '<div style="padding:16px; color:var(--text-secondary)">No transactions</div>'; return; }

        const fmt = (n) => new Intl.NumberFormat('en-US').format(Math.round(n));

        txs.slice(0, 5).forEach(t => {
            const row = document.createElement('div');
            row.className = 'tx-row';
            const isIn = t.type === '買入' || t.type === '配息';
            row.innerHTML = `
            <div style="display:flex; align-items:center; gap:16px">
               <div style="width:40px; height:40px; border-radius:50%; background:#1A1A1A; display:flex; align-items:center; justify-content:center; color:${isIn ? 'var(--color-green)' : 'var(--text-primary)'}">
                  <i class="fa-solid ${isIn ? 'fa-arrow-down' : 'fa-arrow-up'}"></i>
               </div>
               <div>
                  <div style="font-weight:600">${t.ticker}</div>
                  <div class="tx-date">${new Date(t.date).toLocaleDateString()}</div>
               </div>
            </div>
            <div style="text-align:right">
               <div style="font-weight:600">${isIn ? '+' : '-'} ${fmt(t.qty * t.price)}</div>
               <div style="font-size:12px; color:var(--text-secondary)">${t.type}</div>
            </div>
         `;
            el.appendChild(row);
        });
    }

    function renderHoldings(d) {
        const list = document.getElementById('holdingsList');
        if (!list) return;
        list.innerHTML = '';

        const fmt = (n) => new Intl.NumberFormat('en-US').format(Math.round(n));

        const cats = { '現金': [], '股票': [], '加密貨幣': [] };
        if (d.holdings) {
            d.holdings.forEach(h => {
                if (cats[h.cat]) cats[h.cat].push(h);
                else { if (!cats['股票']) cats['股票'] = []; cats['股票'].push(h); }
            });
        }

        for (let c in cats) {
            if (cats[c].length === 0) continue;
            const hdr = document.createElement('div');
            hdr.className = 'section-title';
            hdr.style.fontSize = '16px';
            hdr.style.marginTop = '24px'; css: 'color: var(--text-gold) !important';
            hdr.innerText = c;
            list.appendChild(hdr);

            const card = document.createElement('div');
            card.className = 'card';
            card.style.padding = "0 16px";

            cats[c].forEach(h => {
                if (h.qty <= 0.0001 && h.cat !== '現金') return;
                const isCash = h.cat === '現金';
                const pnlColor = h.pnl >= 0 ? 'var(--color-green)' : 'var(--color-red)';
                const pnlText = isCash ? '' : `${h.pnl >= 0 ? '+' : ''}${fmt(h.pnl)} (${h.roi.toFixed(2)}%)`;

                const row = document.createElement('div');
                row.className = 'asset-row';
                row.onclick = () => window.quickTrade(h.ticker, h.cat);

                row.innerHTML = `
               <div style="display:flex; align-items:center">
                 <div>
                   <div style="font-weight:600; font-size:15px; display:flex; align-items:center; gap:8px">
                      ${h.ticker} 
                      ${h.isUsd ? `<span style="font-size:10px; background:#333; padding:2px 4px; border-radius:4px">USD</span>` : ''}
                   </div>
                   <div style="font-size:12px; color:var(--text-secondary)">${h.qty} @ ${fmt(h.qty > 0 ? (h.marketValue / h.qty) : 0)}</div> 
                 </div>
               </div>
               <div style="text-align:right">
                 <div style="font-weight:600; font-size:15px">${fmt(h.valTWD)}</div>
                 <div style="font-size:12px; color:${pnlColor}">${pnlText}</div>
               </div>
             `;
                card.appendChild(row);
            });
            list.appendChild(card);
        }
    }

    function renderLoan(d) {
        const lList = document.getElementById('loanList');
        const rList = document.getElementById('riskList');
        if (!lList) return;
        lList.innerHTML = ''; rList.innerHTML = '';

        const fmt = (n) => new Intl.NumberFormat('en-US').format(Math.round(n));

        if (d.risks) {
            d.risks.forEach(r => {
                const riskColor = r.status === 'Safe' ? 'var(--color-green)' : (r.status === 'Warning' ? 'var(--color-yellow)' : 'var(--color-red)');
                const ratio = r.ratio === '-' ? 0 : parseFloat(r.ratio);

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
             <div class="card-label">${r.source} Risk</div>
             <div style="display:flex; justify-content:space-between; align-items:center">
                 <div class="card-value" style="font-size:24px">${r.ratio}${r.ratio === '-' ? '' : '%'}</div>
                 <div class="bg-success" style="background:${riskColor}; color:#111; opacity:0.8">${r.status}</div>
             </div>
             <div class="card-sub">${r.label}</div>
             <div style="height:4px; width:100%; background:#333; margin-top:12px; border-radius:2px; overflow:hidden">
                 <div style="height:100%; width:${Math.min(ratio, 100)}%; background:${riskColor}"></div>
             </div>
             <div style="margin-top:12px; font-size:13px; color:var(--text-secondary); display:flex; justify-content:space-between">
                 <span>Col: ${fmt(r.colValTWD)}</span><span>Debt: ${fmt(r.debtTWD)}</span>
             </div>
             `;
                rList.appendChild(card);
            });
        }
        // Add grid stack class here or verify it persists. It was in index.html, not here. 
        // Wait, index.html has div#riskList class="grid-stack". 
        // Here we are appending children, so the class remains on the container. Correct.

        const groups = {};
        if (d.contracts) {
            d.contracts.forEach(l => { if (!groups[l.source]) groups[l.source] = []; groups[l.source].push(l); });
        }

        for (let src in groups) {
            const hdr = document.createElement('div');
            hdr.className = 'section-title';
            hdr.style.fontSize = '16px';
            hdr.style.marginTop = '24px';
            hdr.innerText = src;
            lList.appendChild(hdr);

            const listContainer = document.createElement('div');
            listContainer.className = 'data-list';

            const card = document.createElement('div');
            card.className = 'card';
            card.style.padding = "0 16px";

            groups[src].forEach(l => {
                const row = document.createElement('div');
                row.className = 'asset-row';

                const safeL = {
                    row: l.row, source: l.source, currency: l.currency,
                    collateral: l.col, loanAmount: l.principal,
                    type: l.type, rate: l.rate, debt: l.debt, note: l.note
                };
                const jsonStr = btoa(unescape(encodeURIComponent(JSON.stringify(safeL))));
                row.onclick = function () { window.clickLoan(jsonStr); };

                row.innerHTML = `
               <div>
                  <div style="font-weight:600">${l.col} <i class="fa-solid fa-arrow-right" style="font-size:10px; color:var(--text-secondary)"></i> ${fmt(l.principal)} <span style="font-size:10px">${l.currency}</span></div>
                  <div style="font-size:12px; color:var(--text-secondary)">${l.type} • Rate: ${l.rate}%</div>
               </div>
               <div style="text-align:right">
                   <div style="font-weight:600; color:var(--text-primary)">${fmt(l.debt * (l.currency === 'USD' ? d.fx : 1))} TWD</div>
                   <div style="font-size:11px; color:var(--text-secondary)">${l.note || ''}</div>
               </div>
            `;
                card.appendChild(row);
            });
            lList.appendChild(card);
        }
    }
</script>