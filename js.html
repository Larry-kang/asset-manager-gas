<script>
  const el = (id) => document.getElementById(id);
  const val = (id) => el(id).value;

  // State Management
  const Store = {
    data: null,
    currency: 'TWD',
    fx: 32.5,
    inventory: {},
    theme: 'light',
    sort: 'val' // val, roi, name
  };

  // --- UI Components (New) ---
  const UI = {
    badge: (text, cls) => text ? `<span class="badge ${cls}">${text}</span>` : '',

    metric: (lbl, val, sub = '', style = '') =>
      `<div class="metric" style="${style}"><div class="metric-lbl">${lbl}</div><div class="metric-val">${val}</div>${sub}</div>`,

    card: (cls, titleIcon, titleText, badge, content) =>
      `<div class="card ${cls}"><h2><span class="type-icon">${titleIcon}</span> ${titleText} ${badge}</h2><div class="grid" style="margin-bottom:5px">${content}</div></div>`,

    btn: (lbl, act, data = {}, cls = 'btn-outline') => {
      let attrs = Object.entries(data).map(([k, v]) => `data-${k}="${v}"`).join(' ');
      return `<button class="btn btn-sm ${cls}" data-act="${act}" ${attrs} onclick="clickAction(this)">${lbl}</button>`;
    },

    contractRow: (icon, content, buttons) =>
      `<div class="group-item"><div style="display:flex;justify-content:space-between;align-items:center"><div>${icon} ${content}</div></div><div style="margin-top:5px;text-align:right">${buttons}</div></div>`
  };

  // --- Theme Manager ---
  function initTheme() {
    const saved = localStorage.getItem('theme') || 'light';
    setTheme(saved);
  }

  function toggleTheme() {
    const newTheme = Store.theme === 'light' ? 'dark' : 'light';
    setTheme(newTheme);
  }

  function setTheme(theme) {
    Store.theme = theme;
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
    const btn = el('themeBtn');
    if (btn) btn.innerText = theme === 'light' ? Icons.THEME_DARK : Icons.THEME_LIGHT;
  }

  // --- Logger & UI Utils ---
  function logger(msg, type = 'info') {
    const c = el('devConsole');
    const time = new Date().toLocaleTimeString().split(' ')[0];
    let cls = msg.includes('Error') || msg.includes('失敗') ? 'log-err' : (msg.includes('Success') || msg.includes('完成') || msg.includes('成功') ? 'log-ok' : (msg.includes('Fetching') ? 'log-api' : ''));
    c.innerHTML += `<div class="log-line"><span class="log-time">[${time}]</span> <span class="${cls}">${msg}</span></div>`;
    c.scrollTop = c.scrollHeight;
  }

  function showMsg(text, type = 'info') {
    el('msgModal').style.display = 'flex';
    let title = '通知', icon = '??';
    if (text.includes('錯誤') || text.includes('不足') || text.includes('失敗') || type === 'err') { title = '錯誤'; icon = '?'; }
    else if (text.includes('成功') || text.includes('完成') || text.includes('已')) { title = '成功'; icon = '?'; }
    el('msgIcon').innerText = icon; el('msgTitle').innerText = title; el('msgBody').innerText = text;
  }

  function toggleConsole() { const c = el('devConsole'); if (c.style.display === 'none') { c.style.display = 'block'; el('consoleToggle').innerText = '隱藏 Log'; document.body.style.paddingBottom = '220px'; } else { c.style.display = 'none'; el('consoleToggle').innerText = '顯示 Log'; document.body.style.paddingBottom = '20px'; } }

  function go(id, btn) {
    document.querySelectorAll('.view').forEach(d => d.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    el(id).classList.add('active');
    if (btn) btn.classList.add('active');
    else {
      // Auto-highlight nav button if triggered programmatically
      const navBtn = document.querySelector(`.nav-btn[onclick*="'${id}'"]`);
      if (navBtn) navBtn.classList.add('active');
    }
    if (id === 'dash' || id === 'loan') load();
  }

  function quickTrade(ticker, cat) {
    go('tx');
    el('tType').value = '買入';
    el('tCat').value = cat;
    checkCat(); // Trigger UI update
    el('tTicker').value = ticker;
    el('tQty').value = '';
    el('tPrice').value = '';
    el('tQty').focus();
    showMsg(`已為您準備交易: ${ticker}`, 'info');
  }

  function setSort(s) {
    Store.sort = s;
    if (Store.data) renderHoldings(Store.data.holdings);
  }

  function setCurrency(curr) {
    Store.currency = curr;
    el('btnTWD').classList.toggle('active', curr === 'TWD');
    el('btnUSD').classList.toggle('active', curr === 'USD');
    if (Store.data) render(Store.data, false);
  }

  // --- Formatters ---
  function formatMoney(val) {
    if (isNaN(val) || val === null) val = 0;
    if (Store.currency === 'USD') return '$ ' + Math.round(val / Store.fx).toLocaleString();
    return 'NT$ ' + Math.round(val).toLocaleString();
  }
  function formatLoan(val, curr) {
    if (isNaN(val) || val === null) val = 0;
    if (curr === 'USD') return '$' + Number(val).toFixed(2);
    return 'NT$' + Math.round(val).toLocaleString();
  }
  function getColorClass(value) { if (value > 0) return Store.currency === 'TWD' ? 'color-red' : 'color-green'; if (value < 0) return Store.currency === 'TWD' ? 'color-green' : 'color-red'; return ''; }
  function getBgClass(value) { if (value > 0) return Store.currency === 'TWD' ? 'bg-red' : 'bg-green'; if (value < 0) return Store.currency === 'TWD' ? 'bg-green' : 'bg-red'; return ''; }

  // --- Data Loading ---
  function load(f) {
    logger(f ? '強制更新...' : '讀取中...', 'sys');
    google.script.run.withSuccessHandler(render).withFailureHandler(e => { logger('失敗: ' + e, 'err'); showMsg('讀取失敗: ' + e) }).getDashboardData(f);
  }

  // --- Rendering Logic (Refactored) ---
  function render(payload, showLogs = true) {
    if (!payload) {
      showMsg("錯誤：後端回傳資料為空 (null)", 'err');
      logger("Render Error: Data is null", 'err');
      return;
    }

    let d;
    if (typeof payload === 'string') {
      try {
        d = JSON.parse(payload);
      } catch (e) {
        showMsg("資料解析錯誤", 'err');
        logger("JSON Parse Error: " + e.message, 'err');
        return;
      }
    } else {
      d = payload;
    }

    if (d.status === 'error') {
      showMsg("後端錯誤：\n" + d.message, 'err');
      logger("Backend Error: " + d.message + " | Debug: " + (d.debug ? d.debug.join(' -> ') : ''), 'err');
      return;
    }

    try {
      Store.data = d; Store.fx = d.fx; Store.inventory = d.inventory;

      if (d.knownTickers) updateTickerDatalist(d.knownTickers);

      if (showLogs) {
        if (d.logs) d.logs.forEach(l => logger(l));
        logger('資料更新完成', 'sys');
      }

      updateInventorySelects(val('lType'));
      renderDashboard(d);
      if (d.recentTx) renderRecentTx(d.recentTx);
      renderCharts(d);
      renderHoldings(d.holdings);
      renderRisks(d.risks);
      renderContracts(d.contracts);

    } catch (err) {
      showMsg("介面渲染錯誤：\n" + err.message, 'err');
      logger("Render Error: " + err.stack, 'err');
    }
  }

  function updateInventorySelects(filterType) {
    const selL = el('lCol');
    const selM = el('mTicker');

    // Default to current Loan Form selection if not provided
    if (!filterType) filterType = val('lType');

    let opts = '<option value="" disabled selected>請選擇抵押品</option>';
    let catMap = {};
    if (Store.data && Store.data.holdings) {
      Store.data.holdings.forEach(h => catMap[h.ticker] = h.cat);
    }

    let hasItems = false;
    for (let t in Store.inventory) {
      let qty = Store.inventory[t];
      if (qty <= 0) continue;

      let itemCat = catMap[t];
      // Filter: Only show items matching the requested type (Stock/Crypto)
      if (filterType === '股票' && itemCat !== '股票') continue;
      if (filterType === '加密貨幣' && itemCat !== '加密貨幣') continue;

      opts += `<option value="${t}">${t} (餘: ${Number(qty).toFixed(4)})</option>`;
      hasItems = true;
    }

    if (!hasItems) opts = '<option value="" disabled selected>無可用庫存</option>';

    if (selL) selL.innerHTML = opts;
    if (selM) selM.innerHTML = opts;
  }

  function updateTickerDatalist(tickers) {
    const dl = el('tickerList');
    if (!dl) return;
    // Sort tickers alphabetically
    tickers.sort();
    let opts = '';
    tickers.forEach(t => {
      opts += `<option value="${t}">`;
    });
    dl.innerHTML = opts;
  }

  function renderRecentTx(list) {
    if (!list || list.length === 0) {
      el('recentTxList').innerHTML = '<p style="text-align:center;color:var(--text-sub);padding:20px">無近期交易</p>';
      return;
    }

    let html = '<table style="width:100%;font-size:13px;border-collapse:collapse">';
    html += '<tr style="color:var(--text-sub);text-align:left"><th>日期</th><th>動作</th><th>代號</th><th>數量</th><th>操作</th></tr>';

    list.forEach(tx => {
      let date = tx.date.split('T')[0];
      let color = tx.type === '買入' ? 'var(--red)' : (tx.type === '賣出' ? 'var(--green)' : '');
      // Escape single quotes in JSON string for onclick
      let txJson = JSON.stringify(tx).replace(/'/g, "&#39;");

      html += `<tr style="border-bottom:1px solid var(--border)">
        <td style="padding:8px 0">${date}</td>
        <td style="color:${color}">${tx.type}</td>
        <td>${tx.ticker}</td>
        <td>${Number(tx.qty).toFixed(2)}</td>
        <td style="text-align:right">
          <button class="btn-sm btn-outline" onclick='clickEditTx(${txJson})'>修改</button>
          <button class="btn-sm btn-outline" style="color:var(--red);border-color:var(--red)" onclick="clickDeleteTx(${tx.row})">刪除</button>
        </td>
      </tr>`;
    });
    html += '</table>';
    el('recentTxList').innerHTML = html;
  }

  function clickEditTx(tx) {
    el('tRow').value = tx.row;
    el('tDate').value = tx.date.split('T')[0];
    el('tType').value = tx.type;
    el('tCat').value = tx.cat;
    el('tTicker').value = tx.ticker;
    el('tQty').value = tx.qty;
    el('tPrice').value = tx.price;
    el('tCurrency').value = tx.currency;

    checkCat(); // Update UI state

    el('txTitle').innerText = '修改交易 (Row ' + tx.row + ')';
    el('btnTxSubmit').innerText = '更新交易';
    el('btnTxCancel').style.display = 'inline-block';

    // Scroll to top of form
    el('tx').scrollTop = 0;
  }

  function resetTxForm() {
    el('tRow').value = '';
    el('tDate').value = new Date().toISOString().split('T')[0];
    el('tType').selectedIndex = 0;
    el('tCat').selectedIndex = 0;
    el('tTicker').value = '';
    el('tQty').value = '';
    el('tPrice').value = '';
    el('tCurrency').selectedIndex = 0;

    checkCat();

    el('txTitle').innerText = '新增交易';
    el('btnTxSubmit').innerText = '儲存交易';
    el('btnTxCancel').style.display = 'none';
  }

  function showConfirm(msg, callback, btnText = '確定', btnColor = 'var(--primary)', icon = '??') {
    el('confirmBody').innerText = msg;
    el('confirmIcon').innerText = icon;
    el('confirmModal').style.display = 'flex';

    let oldBtn = el('confirmBtn');
    let newBtn = oldBtn.cloneNode(true);
    oldBtn.parentNode.replaceChild(newBtn, oldBtn);

    newBtn.innerText = btnText;
    newBtn.style.background = btnColor;

    newBtn.onclick = () => {
      closeModal('confirmModal');
      callback();
    };
  }

  function handleActionResponse(r, callback) {
    if (r && r.success) {
      showMsg(r.message);
      if (callback) callback();
    } else {
      showMsg(r ? r.message : "未知錯誤", 'err');
    }
  }

  function clickDeleteTx(row) {
    showConfirm('確定要刪除此筆交易紀錄嗎？(Row ' + row + ')', () => {
      logger('刪除交易中...', 'sys');
      google.script.run.withSuccessHandler((r) => {
        handleActionResponse(r, load);
      }).deleteTx(row);
    }, '刪除', 'var(--red)', '??');
  }

  // ... (render functions removed for brevity in this replace block, ensuring context matches)

  function subTx(btn) {
    if (!val('tTicker')) return showMsg('請輸入代號', 'err');
    btn.disabled = true;

    let d = {
      row: val('tRow'),
      date: val('tDate'),
      type: val('tType'),
      ticker: val('tTicker'),
      cat: val('tCat'),
      qty: val('tQty'),
      price: val('tPrice'),
      currency: val('tCurrency')
    };

    const handler = (r) => {
      handleActionResponse(r, () => {
        if (!d.row) resetTxForm(); // Only reset on add
        load();
      });
      btn.disabled = false;
    };

    if (d.row) {
      google.script.run.withSuccessHandler(handler).editTx(d);
    } else {
      google.script.run.withSuccessHandler(handler).addTx(d);
    }
  }

  function subLoan(btn) {
    let type = val('lType');
    if (type !== Const.TYPE_CREDIT && type !== Const.TYPE_CARD && el('invMsg').innerText.includes('不足')) return showMsg('庫存不足', 'err');
    if (!val('lSource')) return showMsg('請輸入來源', 'err');
    let d = { source: val('lSource'), date: new Date().toISOString().split('T')[0], amount: val('lAmount'), rate: val('lRate'), col: val('lCol'), colQty: val('lQty'), type: val('lType'), totalTerm: val('lTerm'), monthlyPay: val('lMonthPay'), currency: val('lCurrency') };
    btn.disabled = true;
    google.script.run.withSuccessHandler((r) => {
      handleActionResponse(r, load);
      btn.disabled = false;
    }).addLoan(d);
  }

  function subAction(btn) {
    let d = { row: val('mRow'), type: val('mType'), val: val('mVal'), price: (val('mType') === 'increaseLoan' || val('mType') === 'addCol' ? val('mRate') : val('mPrice')), repayAmt: val('mRepayAmt'), addTicker: val('mTicker'), source: val('mSource'), col: val('mCol') };
    btn.disabled = true;
    google.script.run.withSuccessHandler((r) => {
      handleActionResponse(r, () => {
        closeModal('actionModal');
        load();
      });
      btn.disabled = false;
    }).processContractAction(d);
  }

  function initIcons() {
    if (el('btnReload')) el('btnReload').innerText = Icons.REFRESH + ' 強制更新';
  }

  // Init
  window.onload = () => {
    console.log("App Version: v3.1.1 (Check Enabled)");
    initIcons();
    initTheme();
    el('tDate').value = new Date().toISOString().split('T')[0];
    load();
  };
</script>