<script>
    let CASH = 0;
    let DATA = {};

    window.onload = () => {
        const dateInput = document.getElementById('tDate');
        if (dateInput) dateInput.valueAsDate = new Date();
        load();
    };

    let CACHED_PASS = localStorage.getItem('am_pass') || '';

    function doLogin() {
        const pass = document.getElementById('loginPass').value;
        if (pass) {
            CACHED_PASS = pass;
            localStorage.setItem('am_pass', pass);
            load(true);
        }
    }

    function load(refresh = false) {
        if (refresh) setVal('netWorth', 'Loading...');

        google.script.run
            .withSuccessHandler(res => {
                let d;
                try { d = (typeof res === 'string') ? JSON.parse(res) : res; }
                catch (e) { showMsg('Parse Error', 'Failed to parse server response'); return; }

                // Auth Check
                if (d.status === '403') {
                    document.getElementById('loginModal').style.display = 'flex';
                    setVal('netWorth', 'Locked');
                    return;
                }

                // Login Success
                document.getElementById('loginModal').style.display = 'none';

                if (d.status === 'success' || d.success === true) {
                    DATA = d;
                    setVal('netWorth', fmt(d.netWorthTWD));

                    const dc = document.getElementById('dailyChange');
                    if (dc) {
                        const color = d.dailyChange >= 0 ? '#4ADE80' : '#F87171';
                        dc.innerHTML = `<span style="color:${color}">${d.dailyChange >= 0 ? '+' : ''}${fmt(d.dailyChange)}</span> Today`;
                    }

                    renderAssets(d);
                    renderTx(d);
                    renderHoldings(d);
                    renderLoan(d);

                    const tList = document.getElementById('tickerList');
                    if (tList && d.knownTickers) {
                        tList.innerHTML = '';
                        d.knownTickers.forEach(t => {
                            const opt = document.createElement('option');
                            opt.value = t;
                            tList.appendChild(opt);
                        });
                    }
                } else {
                    showMsg('Error', d.message || 'Unknown error');
                }
            })
            .withFailureHandler(err => {
                showMsg('Server Error', err.message);
            })
            .getDashboardData(CACHED_PASS, refresh);
    }

    function setVal(id, val) { const el = document.getElementById(id); if (el) el.innerText = val; }
    function fmt(n) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(n); }
    function showMsg(title, body) {
        document.getElementById('msgTitle').innerText = title;
        document.getElementById('msgBody').innerText = body;
        document.getElementById('msgModal').style.display = 'flex';
    }

    function renderAssets(d) {
        // Hide Skeleton
        const skel = document.getElementById('assetSkeleton');
        if (skel) skel.style.display = 'none';

        if (!d.holdings) return;
        const ctx = document.getElementById('assetChart');
        if (!ctx) return;

        let stock = 0, crypto = 0, cash = 0;
        d.holdings.forEach(h => {
            if (h.cat === '股票') stock += h.valTWD;
            else if (h.cat === '加密貨幣') crypto += h.valTWD;
            else cash += h.valTWD;
        });

        // Cache variable CASH for simple logic use
        CASH = cash;

        const list = document.getElementById('assetList');
        if (list) {
            list.innerHTML = `
             <div class="asset-row"><div>Stocks</div><div>${fmt(getVal(stock))}</div></div>
             <div class="asset-row"><div>Crypto</div><div>${fmt(getVal(crypto))}</div></div>
             <div class="asset-row"><div>Cash</div><div>${fmt(getVal(cash))}</div></div>
          `;
        }

        if (window.myChart) window.myChart.destroy();
        window.myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Stocks', 'Crypto', 'Cash'],
                datasets: [{
                    data: [stock, crypto, cash],
                    backgroundColor: ['#F59E0B', '#3B82F6', '#10B981'],
                    borderWidth: 0
                }]
            },
            options: { cutout: '70%', plugins: { legend: { display: false } } }
        });
    }

    function renderTx(d) {
        const list = document.getElementById('recentTxList');
        if (!list) return;
        list.innerHTML = '';
        if (!d.recentTx || d.recentTx.length === 0) {
            list.innerHTML = '<div style="text-align:center;color:#666;padding:20px">No recent transactions</div>';
            return;
        }
        d.recentTx.slice(0, 5).forEach(t => {
            const isIn = t.type === '買入' || t.type === '配息';
            const row = document.createElement('div');
            row.className = 'asset-row';
            row.innerHTML = `
            <div style="display:flex; align-items:center; gap:12px">
               <div style="width:40px; height:40px; border-radius:50%; background:#1A1A1A; display:flex; align-items:center; justify-content:center; color:${isIn ? 'var(--color-green)' : 'var(--text-primary)'}">
                  <i class="fa-solid ${isIn ? 'fa-arrow-down' : 'fa-arrow-up'}"></i>
               </div>
               <div>
                  <div style="font-weight:600">${t.ticker}</div>
                  <div class="tx-date">${new Date(t.date).toLocaleDateString()}</div>
               </div>
            </div>
            <div style="text-align:right">
               <div style="font-weight:600">${isIn ? '+' : '-'} ${fmt(t.qty * t.price)}</div>
               <div style="font-size:12px; color:var(--text-secondary)">${t.type}</div>
            </div>
         `;
            list.appendChild(row);
        });
    }

    function renderHoldings(d) {
        const list = document.getElementById('holdingsList');
        if (!list) return;
        list.innerHTML = '';

        const cats = { '現金': [], '股票': [], '加密貨幣': [] };
        if (d.holdings) {
            d.holdings.forEach(h => {
                if (cats[h.cat]) cats[h.cat].push(h);
                else { if (!cats['股票']) cats['股票'] = []; cats['股票'].push(h); }
            });
        }

        for (let c in cats) {
            if (cats[c].length === 0) continue;
            const hdr = document.createElement('div');
            hdr.className = 'section-title';
            hdr.style.fontSize = '16px';
            hdr.style.marginTop = '24px'; css: 'color: var(--text-gold) !important';
            hdr.innerText = c;
            list.appendChild(hdr);

            const card = document.createElement('div');
            card.className = 'card';
            card.style.padding = "0 16px";

            cats[c].forEach(h => {
                if (h.qty <= 0.0001 && h.cat !== '現金') return;
                const isCash = h.cat === '現金';
                const pnlColor = h.pnl >= 0 ? 'var(--color-green)' : 'var(--color-red)';
                const pnlText = isCash ? '' : `${h.pnl >= 0 ? '+' : ''}${fmt(h.pnl)} (${h.roi.toFixed(2)}%)`;

                const row = document.createElement('div');
                row.className = 'asset-row';
                row.onclick = () => quickTrade(h.ticker, h.cat);

                row.innerHTML = `
               <div style="display:flex; align-items:center">
                 <div>
                   <div style="font-weight:600; font-size:15px; display:flex; align-items:center; gap:8px">
                      ${h.ticker} 
                      ${h.isUsd ? `<span style="font-size:10px; background:#333; padding:2px 4px; border-radius:4px">USD</span>` : ''}
                   </div>
                   <div style="font-size:12px; color:var(--text-secondary)">${h.qty} @ ${fmt(h.qty > 0 ? (h.marketValue / h.qty) : 0)}</div> 
                 </div>
               </div>
               <div style="text-align:right">
                 <div style="font-weight:600; font-size:15px">${fmt(getVal(h.valTWD))}</div>
                 <div style="font-size:12px; color:${pnlColor}">${isCash ? '' : `${h.pnl >= 0 ? '+' : ''}${fmt(getVal(h.pnl))} (${h.roi.toFixed(2)}%)`}</div>
               </div>
             `;
                card.appendChild(row);
            });
            list.appendChild(card);
        }
    }

    function renderLoan(d) {
        const lList = document.getElementById('loanList');
        const rList = document.getElementById('riskList');
        if (!lList) return;
        lList.innerHTML = ''; rList.innerHTML = '';

        if (!d.risks || d.risks.length === 0) {
            rList.innerHTML = `
                <div style="grid-column: 1 / -1; text-align:center; padding:48px 24px; color:var(--text-secondary); background:var(--bg-card); border-radius:16px; border:1px dashed var(--border-color)">
                    <i class="fa-solid fa-vault" style="font-size:48px; margin-bottom:16px; color:var(--text-gold); opacity:0.5"></i>
                    <div style="font-size:16px; font-weight:600; color:var(--text-primary); margin-bottom:8px">No Active Loans</div>
                    <div style="font-size:13px">Your vault is empty. Create a new loan to get started.</div>
                </div>
            `;
            return;
        }

        if (d.risks) {
            d.risks.forEach(r => {
                const riskColor = r.status === 'Safe' ? 'var(--color-green)' : (r.status === 'Warning' ? '#FBBF24' : 'var(--color-red)');
                const ratio = r.ratio === '-' ? 0 : parseFloat(r.ratio);

                // Visual Bar Logic: 110%~200% mapped to bar width
                let barPct = 0;
                if (ratio > 0) {
                    barPct = Math.min(Math.max((ratio - 110) / (200 - 110) * 100, 5), 100);
                }
                if (ratio > 300) barPct = 100;

                const card = document.createElement('div');
                card.className = 'card';
                card.style.position = 'relative';
                card.onclick = () => openLoanAction(r.source, 'repay');

                card.innerHTML = `
         <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
             <div class="card-label" style="font-size:16px; font-weight:600; color:white">
                <i class="fa-solid fa-shield-halved" style="margin-right:8px; color:var(--text-gold)"></i>${r.source}
             </div>
             <div style="font-size:12px; color:${riskColor}; border:1px solid ${riskColor}; padding:2px 8px; border-radius:12px">
                ${r.status}
             </div>
         </div>

         <!-- Health Bar Section -->
         <div style="margin-bottom:20px">
             <div style="display:flex; justify-content:space-between; align-items:baseline">
                 <div style="color:var(--text-secondary); font-size:12px">Health Factor</div>
                 // Display Unit Logic
                 const isCrypto = r.source.includes('AAVE') || r.source.includes('Crypto');
                 const unit = (r.ratio === '-' || isCrypto) ? '' : '%';
                 
                 <div class="card-value" style="font-size:24px; color:${riskColor}">${r.ratio}${unit}</div>
             </div>
             <div class="health-bar-container">
                 <div class="health-bar-fill" style="width:${barPct}%; background: linear-gradient(90deg, ${riskColor}, ${riskColor}); box-shadow: 0 0 8px ${riskColor}"></div>
             </div>
         </div>
         
         <!-- Split Data Grid -->
         <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; padding-top:16px; border-top:1px solid var(--border-color)">
             <!-- Collateral Col -->
             <div>
                <div style="color:var(--text-secondary); font-size:12px; margin-bottom:4px"><i class="fa-solid fa-layer-group" style="margin-right:6px"></i>Collateral</div>
                <div style="font-weight:600; font-size:15px; color:white">${fmt(getVal(r.colValTWD))}</div>
             </div>
             <!-- Debt Col -->
             <div style="text-align:right">
                <div style="color:var(--text-secondary); font-size:12px; margin-bottom:4px"><i class="fa-solid fa-file-invoice-dollar" style="margin-right:6px"></i>Debt</div>
                <div style="font-weight:600; font-size:15px; color:white">${fmt(getVal(r.debtTWD))}</div>
             </div>
         </div>

         <!-- Actions -->
         <div style="margin-top:20px; display:grid; grid-template-columns:1fr 1fr; gap:12px">
            <button class="btn-gold-pill" style="width:100%; height:40px; font-size:14px; padding:0" onclick="event.stopPropagation(); openLoanAction('${r.source}', 'addCol')">
                <i class="fa-solid fa-plus" style="margin-right:4px"></i>Add Col
            </button>
            <button class="btn-outline" style="width:100%; height:40px; border-radius:99px; font-size:14px; color:var(--text-secondary); border-color:var(--border-color)" onclick="event.stopPropagation(); openLoanAction('${r.source}', 'repay')">
                Repay
            </button>
         </div>
         `;
                rList.appendChild(card);
            });
        }
    }

    function quickTrade(ticker, cat) {
        openTxModal();
        document.getElementById('tTicker').value = ticker;
        document.getElementById('tCat').value = cat;
    }

    /* --- LOAN ACTION HANDLERS --- */
    function openLoanAction(source, type) {
        document.getElementById('modalLoan').style.display = 'flex';
        document.getElementById('lSource').value = source;
        const sel = document.getElementById('lType');
        if (type) { sel.value = type; updateLoanUI(type); }
        document.getElementById('lTitle').innerText = `${source} Action`;
    }

    function subLoan() {
        const type = document.getElementById('lType').value;
        const val = parseFloat(document.getElementById('lVal').value);
        if (isNaN(val) && type !== 'payPeriod') { showMsg('Error', 'Invalid Value'); return; }

        const payload = {
            source: document.getElementById('lSource').value,
            type: type,
            val: val,
            price: parseFloat(document.getElementById('lPrice').value) || 0
        };

        setVal('btnLoan', 'Processing...');
        google.script.run.withSuccessHandler(res => {
            setVal('btnLoan', 'Submit Action');
            document.getElementById('modalLoan').style.display = 'none';
            if (res.success) { showMsg('Success', 'Action Recorded'); load(true); }
            else showMsg('Error', res.message);
        }).processContractAction(payload);
    }

    function subTx() {
        const payload = {
            date: document.getElementById('tDate').value,
            type: document.getElementById('tType').value,
            cat: document.getElementById('tCat').value,
            ticker: document.getElementById('tTicker').value,
            qty: parseFloat(document.getElementById('tQty').value),
            price: parseFloat(document.getElementById('tPrice').value),
            currency: document.getElementById('tCurrency').value
        };
        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                closeTxModal();
                showMsg('Success', 'Transaction Added');
                load(true);
            } else showMsg('Error', res.message);
        }).addTx(payload);
    }

    /* --- WIZARD LOGIC --- */
    let wizProto = 'Sinopac';
    let wizType = 'Stock';

    function openWizard() {
        document.getElementById('modalWizard').style.display = 'flex';
        wizBack(); // Resets to step 1
    }
    function closeWizard() { document.getElementById('modalWizard').style.display = 'none'; }

    function setWizProto(proto, type) {
        wizProto = proto; wizType = type;
        document.getElementById('wizStep1').classList.add('hidden');
        document.getElementById('wizStep2').classList.remove('hidden');

        // Stepper Update
        document.getElementById('wizDot2').classList.add('active');

        document.getElementById('wizProtoLabel').innerText = `${proto} (${type})`;

        document.getElementById('wizInputStock').classList.add('hidden');
        document.getElementById('wizInputCrypto').classList.add('hidden');

        if (type === 'Stock') initWizStock();
        else if (type === 'Crypto') initWizCrypto();
    }

    function wizBack() {
        document.getElementById('wizStep1').classList.remove('hidden');
        document.getElementById('wizStep2').classList.add('hidden');

        // Stepper Update
        document.getElementById('wizDot1').classList.add('active');
        document.getElementById('wizDot2').classList.remove('active');
    }

    function initWizStock() {
        document.getElementById('wizInputStock').classList.remove('hidden');
        const sel = document.getElementById('wizStockTicker');
        sel.innerHTML = '<option disabled selected>Select Stock</option>';
        if (DATA.holdings) {
            DATA.holdings.filter(h => h.cat === '股票').forEach(h => {
                const opt = document.createElement('option');
                opt.value = h.ticker;
                opt.innerText = `${h.ticker} (Qty: ${h.qty})`;
                sel.appendChild(opt);
            });
        }
        sel.onchange = () => {
            const t = DATA.holdings.find(h => h.ticker === sel.value);
            document.getElementById('wizStockQty').innerText = t ? `Avail: ${t.qty}` : '0';
        };
    }

    function initWizCrypto() {
        document.getElementById('wizInputCrypto').classList.remove('hidden');
        const box = document.getElementById('wizCryptoRows');
        box.innerHTML = '';
        addCryptoRow();
    }

    function addCryptoRow() {
        const div = document.createElement('div');
        div.style.marginBottom = '8px';
        div.style.display = 'grid';
        div.style.gridTemplateColumns = '1fr 1fr 32px';
        div.style.gap = '8px';
        div.innerHTML = `
           <input type="text" placeholder="Asset (BTC)" class="wiz-c-asset">
           <input type="number" placeholder="Amt" class="wiz-c-amt">
           <div style="display:flex;align-items:center;justify-content:center;color:red" onclick="this.parentElement.remove()"><i class="fa-solid fa-trash"></i></div>
         `;
        document.getElementById('wizCryptoRows').appendChild(div);
    }

    function subWizard() {
        setVal('wizBtn', 'Processing...');

        let payload = {};

        if (wizProto === 'Sinopac') {
            const tTicker = document.getElementById('wizStockTicker').value;
            const tAmt = document.getElementById('wizStockLoan').value;
            if (!tTicker || !tAmt) { showMsg('Error', 'Missing fields'); return; }

            // Extract ticker from "2330 (Qty: 1000)"
            const realTicker = tTicker.split(' ')[0];

            payload = {
                proto: 'Sinopac',
                col: realTicker,
                qty: 1000, // TODO: Logic to get Max or User Input? 
                // Current UI only has "Avail: 0" label, no input for Qty? 
                // Wait, the UI in index.html (wizInputStock) only has a SELECT and Amount Input. 
                // It assumes PLEDGING ALL AVAILABLE? Or user needs input?
                // Let's look at lines 272-278 of index.html. 
                // There is NO input for Quantity. Just "Select Stock" (which implies All?) 
                // and "Loan Amount".
                // Let's assume we pledge ALL available for simplicity, or we default to 1000?
                // Actually, let's look at initWizStock(). 
                // It confirms avail qty. 
                // Let's grab the Qty from DATA for safe measure.
                amount: tAmt
            };

            // Find Qty from DATA
            const h = DATA.holdings.find(h => h.ticker === realTicker);
            if (h) payload.qty = h.qty;
        }
        else if (wizProto === 'LineBank') {
            // UI for LineBank? index.html lines 257 select proto. 
            // But wizStep2 shares "wizInputStock" or "wizInputCrypto".
            // We need a "wizInputCredit" or reuse Stock?
            // The UI code `setWizProto` only inits Stock or Crypto. 
            // LineBank (Credit) is missing a tailored UI.
            // Hack: Reuse Stock UI but hide Collateral? 
            // For now, let's just make it simple: Credit Loan = Stock Loan UI but ignore ticker.

            const tAmt = document.getElementById('wizStockLoan').value;
            payload = { proto: 'LineBank', amount: tAmt };
        }
        else if (wizProto === 'AAVE') {
            // Collect Rows
            const rows = document.querySelectorAll('#wizCryptoRows > div');
            let assets = [];
            rows.forEach(r => {
                const t = r.querySelector('.wiz-c-asset').value;
                const q = r.querySelector('.wiz-c-amt').value;
                if (t && q) assets.push({ ticker: t, qty: q });
            });

            // Where is Debt Amount input for Crypto?
            // It's not in the UI (wizInputCrypto). 
            // We need to add it or prompt it.
            // Actually, let's assume the user enters negative USDT in the asset list? 
            // No, wizard usually asks "How much to borrow".
            // Let's add a prompt for now or assume 0 debt (just deposit).
            // Better: Add a prompt.
            let debt = document.getElementById('wizCryptoBorrow').value;
            if (!debt) { showMsg('Error', 'Please enter borrow amount'); return; }

            payload = {
                proto: 'AAVE',
                assets: assets,
                amount: debt
            };
        }

        google.script.run.withSuccessHandler(res => {
            closeWizard();
            showMsg('Success', res);
            load(true);
        }).processWizard(payload);
    }

    /* --- DEPRECATED THEME LOGIC --- */
    // Dark mode is now standard. toggleTheme removed.

    /* --- CURRENCY & I18N LOGIC --- */
    let CURRENCY = 'TWD';
    let curLang = 'zh';

    function setCurrency(val) {
        CURRENCY = val;

        // UI Visual Update
        document.getElementById('btnTWD').classList.toggle('active', val === 'TWD');
        document.getElementById('btnUSD').classList.toggle('active', val === 'USD');

        // Save Prefs
        autoSaveSettings();

        // Re-render everything with new currency
        if (DATA && DATA.status) {
            // Recalculate Dashboard Value
            let total = DATA.netWorthTWD;
            if (val === 'USD' && DATA.fx) total = total / DATA.fx;
            setVal('netWorth', fmt(total));

            let daily = DATA.dailyChange;
            if (val === 'USD' && DATA.fx) daily = daily / DATA.fx;

            const dc = document.getElementById('dailyChange');
            if (dc) {
                const color = DATA.dailyChange >= 0 ? 'var(--success)' : 'var(--danger)';
                dc.innerHTML = `<span style="color:${color}">${DATA.dailyChange >= 0 ? '+' : ''}${fmt(daily)}</span> Today`;
            }

            renderAssets(DATA);
            renderTx(DATA);
            renderHoldings(DATA);
            renderLoan(DATA);
        }
    }

    function toggleLang() {
        setLang(curLang === 'zh' ? 'en' : 'zh');
    }

    function fmt(n) {
        if (!n && n !== 0) return '-';
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: CURRENCY,
            minimumFractionDigits: 0
        }).format(n);
    }

    // Helper to get Value in Current Currency
    function getVal(valTWD) {
        if (CURRENCY === 'USD' && DATA.fx) return valTWD / DATA.fx;
        return valTWD;
    }

    /* --- SETTINGS PERSISTENCE --- */
    function autoSaveSettings() {
        const prefs = { currency: CURRENCY, lang: curLang };
        localStorage.setItem('am_prefs', JSON.stringify(prefs));
    }

    function loadSettings() {
        try {
            const p = JSON.parse(localStorage.getItem('am_prefs'));
            if (p) {
                if (p.currency) setCurrency(p.currency);
                if (p.lang) setLang(p.lang);
            }
        } catch (e) { console.error('Error loading settings', e); }
    }

    /* --- REAL i18n LOGIC --- */
    const i18nData = {
        'SysStat': { zh: '系統狀態', en: 'System Status' },
        'RunDig': { zh: '執行診斷', en: 'Run Diagnostics' },
        'Lang': { zh: '語言', en: 'Language' },
        'Vault': { zh: '金庫', en: 'Vault' },
        'Dash': { zh: '儀表板', en: 'Dashboard' },
        'Tx': { zh: '交易', en: 'Transactions' },
        'Set': { zh: '設定', en: 'Settings' }
    };

    let curLang = 'zh'; // Default
    function setLang(lang) {
        curLang = lang;

        // Update Text
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (i18nData[key] && i18nData[key][lang]) {
                el.innerText = i18nData[key][lang];
            }
        });

        // Update Toggle Text (Visual Feedback)
        const el = document.querySelector('[data-i18n="Lang"] + div');
        if (el) el.innerText = lang === 'zh' ? '中文' : 'English';
    }

    function runSystemCheck() {
        showMsg('System Check', 'Diagnostics running... All systems nominal. Connection to Google Apps Script: Active.');
    }

    // Init
    window.onload = function () {
        load(); // Fetch Data
        loadSettings(); // Apply Prefs
    };
</script>