# Asset Manager (資產管家) - Self-Hosted Edition

這是一個專為「重視數據隱私」的投資者設計的 Google Apps Script (GAS) 資產管理系統。
不同於 SaaS 服務，您的所有財務數據都完整保存在您自己的 **Google Sheets** 中，沒有外流風險。

---

## 🚀 快速開始 (使用手冊)

### 1. 部署與安裝
詳細部署流程請參閱 [開發者指南](docs/developer/DEVELOPMENT.md)。
目前已完成自動部署，請開啟 Web App URL。

### 2. 初始設定 (First Run)
首次開啟時，系統處於「無密碼保護」狀。
若需啟用保護，請在 GAS 編輯器執行 `doSetup('您的密碼')`。
*(若您使用 Local Server，預設密碼為 `1234`)*

### 3. 操作流程建議 (從零開始)
若您的資料庫是全新的，請依照以下順序建立資料：

#### Step A: 注入資金 (Add Funds)
1. 點擊右上角 `+ New` 或 `Add Funds`。
2. 類別選擇 **「收入」** (Income)。
3. 幣別選擇 **TWD**，金額輸入您的初始本金 (如 1,000,000)。
4. *此步驟確保您的「總淨值」正確起算。*

#### Step B: 建立持倉 (Buy Assets)
1. 點擊 `+ New` > 選擇 **「買入」**。
2. 輸入代號 (如 `2330`)、數量 (如 `1000`)、價格。
3. 系統會自動計算您的持倉均價與庫存。

#### Step C: 建立負債 (Loans)
1. 點擊左側 `Vault` (金庫)。
2. 點擊 `+ New Loan` 開啟借貸精靈。
3. 選擇協議：
   - **Line Bank**: 輸入信貸金額，系統自動試算月付金。
   - **Sinopac**: 選擇已有的股票作為抵押 (需先完成 Step B)，輸入借款金額。
   - **AAVE**: 選擇加密貨幣作為抵押，輸入借款 USDC 數量。

### 4. 日常維護
- **每日**: 系統會自動記錄淨值變動。
- **還款**: 在 Vault 中點擊卡片 -> `Repay`。
- **交易**: 在 Transactions 查看完整歷史。

---

## 🔒 GasStore 架構說明
本系統採用 **GasStore** (自研 NoSQL 引擎) 取代傳統的 Google Sheet 讀寫。
- **效能**: 讀取速度提升 5x (快取機制)。
- **鎖定**: 寫入時自動啟動 Mutex Lock，防止多人操作衝突。
- **資料庫**: 資料實際儲存於 `_DB_STORE` 分頁 (JSON 格式)，**請勿手動修改該分頁內容**。

---

## ✨ 核心功能
*   **🛡️ 借貸風控 (USP)**: 
    *   **多協議支援**: 股票 (維持率)、加密貨幣 (LTV)、信貸 (攤還)。
    *   **借貸精靈 (New)**: 引導式介面，自動查詢庫存並建立合約。
*   **📊 自動記帳**:
    *   **利息分離**: 還款時自動將利息計入支出。
    *   **每日快照**: 自動記錄每日淨值變動。
*   **📱 極致隱私**: 數據在您手，程式在您手。

---

## 檔案結構


1. **Code.gs** (後端核心)
   - 負責與 Google Sheets 資料庫互動。
   - `getData`: 核心資料流，整合報價、庫存、借貸與風險計算。
   - `updateMarketPrices`: 雙軌抓價引擎 (TwStock 爬蟲 / Crypto API)。
   - `processContractAction`: 處理複雜合約操作 (FIFO還款、增貸、補抵押、繳款)。
   - `getRecentTransactions`: 讀取近期交易紀錄。

2. **Logic.gs** (業務邏輯)
   - `getInventoryMap`: 獨立的庫存檢核邏輯。
   - `calculateLoans`: 借貸風險計算核心。
   - `calculatePortfolio`: 資產組合計算核心。

3. **Actions.gs** (寫入操作)
   - `addTx`, `editTx`, `deleteTx`: 交易紀錄 CRUD。
   - `addLoan`: 新增借貸合約。

4. **Tests.gs** (測試模組)
   - `runSystemCheck`: 系統自我檢測與整合測試。

5. **index.html** (前端骨架)
   - 僅包含 HTML 結構與容器。
   - 使用 `include()` 動態載入 CSS 與 JS 模組。

6. **css.html** (樣式模組)
   - 包含所有 CSS 樣式。
   - 實作 CSS Variables 系統，支援 **深色模式 (Dark Mode)** 切換。

7. **js.html** (邏輯模組)
   - 包含所有前端 JavaScript 邏輯 (SPA 路由、DOM 操作、資料渲染)。
   - 內建 `Store` 狀態管理與 `ThemeManager` 主題控制器。

---

## 功能列表

### 1. 資產看板 (Dashboard)
* **深色模式**：支援 Light / Dark 主題一鍵切換 (自動記憶設定)。
* **核心指標**：顯示淨資產、總資產 (自動扣除負債)。
* **動態幣別**：右上角可切換 **TWD / USD**，全站數值即時換算。
* **持倉明細**：
    * 顯示資產名稱、類別、現價、均價。
    * **智慧損益**：包含報酬率 (%) 與 損益金額。
    * **紅綠燈邏輯**：依據幣別自動切換漲跌顏色 (TWD: 紅漲綠跌 / USD: 綠漲紅跌)。
    * **庫存過濾**：自動隱藏數量為 0 的資產。
    * **快速交易**：點擊代號可直接跳轉至交易頁面並自動填入代號。
    * **排序功能**：支援依市值、報酬率、代號排序。

### 2. 交易登錄 (Transaction)
* **CRUD 管理**：支援新增、讀取、修改、刪除交易紀錄。
* **近期交易**：顯示最近 10 筆交易，並提供修改與刪除按鈕。
* **支援動作**：買入、賣出、配息。
* **智慧填單**：
    * 選擇「現金」類別時，自動鎖定代號並填入對應幣別。
    * **Autocomplete**：代號輸入框支援自動完成 (Datalist)。
* **寫入檢查**：強制檢查必填欄位。

### 3. 負債管理 (Loan Management)
* **多類型支援**：
    * **股票/加密貨幣質押**：計算維持率、LTV，支援增貸與補抵押。
    * **信用貸款**：顯示還款進度 (期數)、月付金。
    * **信用卡費**：簡化顯示，支援一鍵繳清。
* **視圖聚合 (Aggregation)**：
    * 同一來源 (Source) 下的相同資產 (Ticker)，自動合併顯示為一行。
    * 自動計算群組總借款、總抵押價值與剩餘可借額度。
* **進階操作**：
    * **增貸 (Increase Loan)**：依附於特定抵押品，獨立計算利息與日期。
    * **補抵押 (Add Collateral)**：可從庫存中選擇資產 (支援混抵)，後端自動檢核閒置庫存。
    * **現金還款 (Repay)**：採用 FIFO (先進先出) 邏輯，優先償還舊合約利息與本金。
    * **賣出還款 (Sell to Repay)**：自動賣出抵押品並償還負債，同步寫入交易紀錄。
    * **繳款 (Pay Period)**：信貸推進期數，卡費直接結清。
* **手機優化**：抵押品選擇改為原生 Select 選單，解決手機鍵盤遮擋問題。

---

## 資料庫規格 (Google Sheets)

### 分頁 A: `交易紀錄`
| 欄位 | A | B | C | D | E | F | G | H |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **內容** | 日期 | 動作 | 代號 | 類別 | 數量 | 單價 | 幣別 | 備註 |

### 分頁 B: `借貸紀錄` (14 欄)
| 欄位 | A | B | C | D | E | F | G |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **內容** | 來源 | 日期 | 金額(本金) | 利率 | 抵押品 | 數量 | 類型 |

| 欄位 | H | I | J | K | L | M | N |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **內容** | 告警 | 清算 | 備註 | 總期數 | 已還期數 | 月付金 | 幣別 |

### 分頁 C: `MarketData` (自動維護)
- 系統自動抓取報價並快取於此 (快取 15 分鐘)。

---

## 變更歷程 (Changelog)

### Security (Optional)
Previously password-protected, now open by default for simplified access.
To re-enable locking, see `archive/` documentation (legacy).
- [Feat] **即時市場數據**: 整合 Exchangerate-api (匯率), Binance (加密貨幣), Yahoo Finance (台股) 並實作快取機制。
- [Feat] **還款邏輯優化**: 實作精確的利息計算與本息分離記帳，還款時自動計算應計利息。
- [Feat] **完整測試套件**: 重建單元測試與導航測試，並新增「系統整合測試 (Integration Tests)」覆蓋完整資產生命週期。
- [Arch] **配置中心化**: 將資料庫與加密金鑰移至 `Constants.gs` 統一管理。

### v3.1.1 (UX Enhanced + Mobile Fix)
- [Fix] **手機版優化**：將抵押品輸入框改為原生 `<select>`，解決手機版無法選取的問題。
- [UI] **統一介面**：全面移除 `alert/confirm`，改用自定義 Modal，包含刪除確認視窗。
- [Feature] **交易管理**：實作完整的交易紀錄修改 (Edit) 與刪除 (Delete) 功能。
- [Feature] **近期交易**：新增近期交易列表視圖。
- [Feature] **UX 增強**：新增持倉排序 (市值/ROI)、快速交易跳轉、庫存智慧過濾。
- [Test] **測試覆蓋**：更新 `Tests.gs` 以覆蓋新的交易 API。

### v3.0.0 (Major Update)
- [Arch] **前端模組化**：將原本龐大的 `index.html` 拆解為 `css.html` (樣式) 與 `js.html` (邏輯)，提升維護性。
- [Feature] **深色模式 (Dark Mode)**：新增主題切換功能，支援系統級變數 (`:root` vs `[data-theme="dark"]`)。
- [UI] 全面優化圖示顯示，解決編碼問題 (`?` -> Emoji)。
- [Core] 後端新增 `include()` 函式以支援模板引入。

### Dev v2.5.x
- [Fix] 修復群組聚合時的 NaN 錯誤。
- [UI] 新增自定義訊息視窗 (`showMsg`)，取代原生 `alert`，移除瀏覽器網址提示。

### Dev v2.4.x
- [Fix] 修復合約操作 Modal 重置邏輯，解決欄位殘留問題。
- [UI] 負債卡片標題加入動態幣別顯示 (如: 負債 (USD))。

### Dev v2.3
- [Feature] 優化「卡費」邏輯，繳款即視為全額結清，不顯示期數。
- [UI] 調整信貸與卡費的資訊卡顯示欄位。

### Dev v2.2
- [Fix] 修正庫存檢核邏輯錯誤：從檢查「總持倉」改為檢查「閒置持倉 (總持倉 - 已抵押)」。

### Dev v2.1
- [Fix] 修復抵押品下拉選單消失的問題。
- [Fix] 修復負債列表視圖聚合失效的問題。

### Dev v2.0
- [UI] 大幅更新介面風格，引入四種資產類型的專屬色系 (藍/橘/綠/紅)。
- [Feature] 資訊卡依類型顯示不同指標 (股票:維持率 / Crypto:LTV / 信貸:期數)。

### Dev v1.x
- [Core] 建立 FIFO 還款核心。
- [Core] 實作增貸與補抵押邏輯。
- [Core] 實作平均成本法損益計算。
